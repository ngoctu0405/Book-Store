<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo Cáo Tồn Kho - Literary Haven Admin</title>

    <link rel="stylesheet" href="../bootstrap-5.3.2-dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../assets/css/admin_style.css">
    
    <style>
        .report-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }
        .report-header {
            background-color: #4f9da6;
            color: white;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            padding: 1rem 1.5rem;
            font-size: 1.5rem;
            font-weight: 600;
        }
        .filter-section {
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        .table th, .table td {
            vertical-align: middle;
            font-size: 0.95rem;
        }
        .table th {
             font-weight: 600;
             color: #343a40;
        }
        .total-row {
            font-weight: bold;
            background-color: #e9ecef !important;
        }
        
        /* Responsive cho thiết bị di động (max-width: 768px) */
@media (max-width: 768px) {
    /* 1. Body: Chuyển hướng Flexbox thành column để Sidebar và Main-Content xếp chồng */
    body {
        display: flex !important;
        flex-direction: column !important; /* Quan trọng: Sidebar sẽ nằm trên Main-Content */
        overflow-x: hidden; /* Tắt cuộn ngang vì đã xếp chồng */
    }

    /* 2. Sidebar: Sidebar giờ chiếm toàn bộ chiều rộng (100%) */
    .sidebar {
        width: 100% !important; 
        /* Tắt vh-100 vì giờ nó nằm ngang, không cần chiều cao toàn màn hình */
        height: auto !important; 
        flex-shrink: 0;
        display: flex !important;
        
        /* Bổ sung: Điều chỉnh Sidebar để dễ sử dụng hơn khi nằm ngang */
        overflow-x: auto; /* Cho phép menu cuộn ngang nếu có nhiều mục */
        white-space: nowrap; /* Ngăn các mục menu xuống dòng */
    }
    
    /* 3. Main Content: Đảm bảo nội dung chính chiếm toàn bộ chiều rộng */
    .main-content {
        width: 100%;
        min-width: auto;
    }
    
    /* 4. Tinh chỉnh Padding và Kích thước (bên trong page-content) */
    .page-content {
        padding: 15px !important;
    }

    .page-content h1 {
        font-size: 20px;
        margin-bottom: 15px;
    }

    /* 5. Điều chỉnh bảng (Đảm bảo bảng vẫn cuộn ngang nếu quá nhiều cột) */
    .table-responsive {
        border: 1px solid var(--border-color);
        border-radius: 12px;
        overflow-x: auto; 
        -webkit-overflow-scrolling: touch;
    }

    .table {
        min-width: 600px; /* Vẫn cần min-width cho bảng */
    }

    .table thead th, 
    .table tbody td {
        padding: 8px 6px; 
        font-size: 12px; 
    }
    
    .profit-input {
        width: 50px;
        padding: 4px 2px;
        font-size: 12px;
    }

    .btn-sm {
        padding: 3px 6px; 
        font-size: 10px;
    }
    
    .table tbody td span.small {
        display: none;
    }
}

/* Kích hoạt lại bố cục Desktop (Sidebar nằm cạnh Main-Content) */
@media (min-width: 769px) {
    body {
        display: flex !important; 
        flex-direction: row !important; /* Khôi phục thành row trên desktop */
        overflow-x: hidden; 
    }
    .sidebar {
        /* Giả sử chiều rộng desktop là 250px */
        width: 250px !important; 
        height: 100vh !important; /* Khôi phục vh-100 trên desktop */
        display: flex !important;
    }
    .main-content {
        width: 100%;
    }
}
    
    </style>
</head>
<body>
    
    <aside class="sidebar d-flex flex-column vh-100">
        <div class="sidebar-header">
            Literary Haven
        </div>

        <ul class="nav nav-pills flex-column mb-auto">
            <li class="nav-item">
                <a href="dashboard.html" class="nav-link">
                    <span class="nav-icon">◈</span>
                    <span>Bảng điều khiển</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="users.html" class="nav-link">
                    <span class="nav-icon">◉</span>
                    <span>Khách hàng</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="categories.html" class="nav-link">
                    <span class="nav-icon">◫</span>
                    <span>Loại sản phẩm</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="products.html" class="nav-link">
                    <span class="nav-icon">◪</span>
                    <span>Sản phẩm</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="purchase-orders.html" class="nav-link">
                    <span class="nav-icon">◩</span>
                    <span>Nhập hàng</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="pricing.html" class="nav-link">
                    <span class="nav-icon">◎</span>
                    <span>Quản lý giá</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="orders.html" class="nav-link">
                    <span class="nav-icon">◧</span>
                    <span>Đơn hàng</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="inventory.html" class="nav-link">
                    <span class="nav-icon">◨</span>
                    <span>Tồn kho</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="reports.html" class="nav-link">
                    <span class="nav-icon">◔</span>
                    <span>Báo cáo</span>
                </a>
            </li>
        </ul>
        
        <div class="mt-auto p-3">
            <a href="index.html" class="logout-link">
                <span>◀</span>
                <span>Đăng xuất</span>
            </a>
        </div>
    </aside>

    <main class="main-content">
        <div class="container-fluid py-4">
            <h1 class="mb-4">Báo Cáo Nhập - Xuất - Tồn</h1>

            <div class="filter-section">
                <h3 class="h5 mb-3">Lọc theo khoảng thời gian</h3>
                <div class="row align-items-end">
                    <div class="col-md-4 mb-3">
                        <label for="startDate" class="form-label">Từ ngày:</label>
                        <input type="date" id="startDate" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="endDate" class="form-label">Đến ngày:</label>
                        <input type="date" id="endDate" class="form-control">
                    </div>
                    <div class="col-md-4 mb-3">
                        <button class="btn btn-primary w-100" onclick="initReport()">
                            <i class="bi bi-search"></i> Xem Báo Cáo
                        </button>
                    </div>
                </div>
            </div>

            <div class="card report-card">
                <div class="report-header">
                   Kết Quả Báo Cáo Tồn Kho
                   <small class="float-end pt-1" id="reportTimeRange"></small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th scope="col">Mã SP</th>
                                    <th scope="col">Tên Sách</th>
                                    <th scope="col" class="text-center">Tồn Đầu Kỳ</th>
                                    <th scope="col" class="text-center text-success">Nhập Trong Kỳ</th>
                                    <th scope="col" class="text-center text-danger">Xuất Trong Kỳ</th>
                                    <th scope="col" class="text-center">Tồn Cuối Kỳ</th>
                                </tr>
                            </thead>
                            <tbody id="reportTableBody">
                                <tr><td colspan="6" class="text-center">Vui lòng chọn khoảng thời gian và nhấn 'Xem Báo Cáo'.</td></tr>
                            </tbody>
                            <tfoot id="reportTableFooter">
                                </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <script src="../bootstrap-5.3.2-dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/main.js"></script> 

    <script>
        // === MOCK DATA SETUP ===
        // GIẢ ĐỊNH: Bạn cần tích hợp việc ghi log này vào main.js (hoặc file admin_main.js)
        // để lưu trữ vào localStorage key 'bs_transactions'
        function getTransactionLog() {
            try {
                 const logString = localStorage.getItem('bs_transactions');
                 return JSON.parse(logString) || [];
            } catch (e) {
                // Mock data nếu không tìm thấy log hoặc lỗi
                const today = new Date();
                const pastDate = new Date();
                pastDate.setDate(today.getDate() - 30); // 30 ngày trước

                return [
                    // Nhập hàng (IMPORT)
                    { id: 1, type: 'IMPORT', productId: 1, qty: 100, date: pastDate.toISOString() }, 
                    { id: 2, type: 'IMPORT', productId: 2, qty: 50, date: pastDate.toISOString() }, 
                    
                    // Bán hàng (SALE/XUẤT)
                    { id: 3, type: 'SALE', productId: 1, qty: 5, date: '2025-10-15T10:00:00.000Z' },
                    { id: 4, type: 'SALE', productId: 2, qty: 10, date: '2025-10-20T11:00:00.000Z' },
                    { id: 5, type: 'SALE', productId: 1, qty: 15, date: '2025-10-25T14:30:00.000Z' },
                    { id: 6, type: 'IMPORT', productId: 1, qty: 50, date: '2025-10-26T09:00:00.000Z' }, 
                    { id: 7, type: 'SALE', productId: 3, qty: 2, date: today.toISOString() },
                ];
            }
        }
        
        /**
         * Lấy tất cả dữ liệu sản phẩm hiện tại.
         * (Giả định hàm getData() đã được định nghĩa trong main.js)
         */
        function getProductsData() {
            const data = typeof getData === 'function' ? getData() : { products: [] };
            return data.products || [];
        }

        // === CORE LOGIC ===

        /**
         * Tạo báo cáo Nhập - Xuất - Tồn theo khoảng thời gian.
         * @param {Date} start - Ngày bắt đầu.
         * @param {Date} end - Ngày kết thúc.
         */
        function generateInventoryReport(start, end) {
            const products = getProductsData();
            const log = getTransactionLog();

            // Sắp xếp log theo thời gian để đảm bảo tính toán Tồn Đầu chính xác
            log.sort((a, b) => new Date(a.date) - new Date(b.date));

            const report = {}; // Dùng object để lưu trữ theo productId

            // 1. Khởi tạo Tồn Đầu Kỳ cho tất cả sản phẩm
            products.forEach(p => {
                report[p.id] = {
                    id: p.id,
                    sku: p.sku || 'N/A',
                    name: p.name || 'Sản phẩm không rõ',
                    initialStock: 0,
                    importQty: 0,
                    exportQty: 0,
                    finalStock: p.qty || 0 // Lấy Tồn Cuối (hiện tại)
                };
            });

            // 2. Phân tích Log để tính toán
            // Logic tính Tồn Đầu/Cuối:
            // Tồn Đầu Kỳ = Tồn Cuối Kỳ (hiện tại) + Tổng Xuất (từ ngày Start đến nay) - Tổng Nhập (từ ngày Start đến nay)
            
            // Tính tổng Nhập/Xuất trong và ngoài kỳ
            log.forEach(item => {
                const itemDate = new Date(item.date);
                const productId = item.productId;
                const qty = item.qty || 0;
                
                if (!report[productId]) return; // Bỏ qua nếu không tìm thấy sản phẩm

                // Kiểm tra xem giao dịch có nằm trong khoảng thời gian báo cáo không
                const isWithinPeriod = itemDate >= start && itemDate <= end;

                if (item.type === 'IMPORT') {
                    if (isWithinPeriod) {
                        report[productId].importQty += qty;
                    } 
                    // Để tính Tồn Đầu Kỳ, ta cần đảo ngược các giao dịch xảy ra SAU Tồn Đầu
                    else if (itemDate > start) {
                        report[productId].initialStock -= qty; // Đảo ngược nhập
                    }
                } else if (item.type === 'SALE') {
                    if (isWithinPeriod) {
                        report[productId].exportQty += qty;
                    } 
                    else if (itemDate > start) {
                        report[productId].initialStock += qty; // Đảo ngược xuất
                    }
                }
            });

            // 3. Tính toán Tồn Đầu và Tồn Cuối chính xác
            Object.values(report).forEach(item => {
                 // Tồn Đầu Kỳ = Tồn Cuối Kỳ (hiện tại) + Tổng Xuất (từ Start đến nay) - Tổng Nhập (từ Start đến nay)
                 // Do ta đã đảo ngược các giao dịch sau Start Date vào initialStock ở bước 2, 
                 // ta chỉ cần cộng thêm Tồn Cuối (p.qty) để ra Tồn Đầu Kỳ:
                 item.initialStock = item.finalStock + item.initialStock;
                 
                 // Tồn Cuối Kỳ trong kỳ báo cáo (đã tính Nhập/Xuất trong kỳ)
                 item.finalStock = item.initialStock + item.importQty - item.exportQty;

                 // Đảm bảo số lượng không âm
                 item.initialStock = Math.max(0, item.initialStock);
                 item.finalStock = Math.max(0, item.finalStock);
            });

            return Object.values(report);
        }

        /**
         * Hiển thị dữ liệu báo cáo lên bảng.
         */
        function renderReport(reportData, start, end) {
            const tableBody = document.getElementById('reportTableBody');
            const tableFooter = document.getElementById('reportTableFooter');
            const timeRangeElement = document.getElementById('reportTimeRange');
            if (!tableBody || !tableFooter) return;

            let html = '';
            let totalInitial = 0;
            let totalImport = 0;
            let totalExport = 0;
            let totalFinal = 0;

            if (reportData.length === 0) {
                html = '<tr><td colspan="6" class="text-center">Không tìm thấy dữ liệu giao dịch hoặc sản phẩm trong khoảng thời gian này.</td></tr>';
            } else {
                reportData.forEach(item => {
                    html += `
                        <tr>
                            <td>${item.sku}</td>
                            <td>${item.name}</td>
                            <td class="text-center">${item.initialStock}</td>
                            <td class="text-center text-success fw-bold">${item.importQty}</td>
                            <td class="text-center text-danger fw-bold">${item.exportQty}</td>
                            <td class="text-center fw-bold">${item.finalStock}</td>
                        </tr>
                    `;
                    totalInitial += item.initialStock;
                    totalImport += item.importQty;
                    totalExport += item.exportQty;
                    totalFinal += item.finalStock;
                });
            }
            tableBody.innerHTML = html;

            // Render Footer (Tổng cộng)
            tableFooter.innerHTML = `
                <tr class="total-row">
                    <td colspan="2" class="text-end">TỔNG CỘNG:</td>
                    <td class="text-center">${totalInitial}</td>
                    <td class="text-center text-success">${totalImport}</td>
                    <td class="text-center text-danger">${totalExport}</td>
                    <td class="text-center">${totalFinal}</td>
                </tr>
            `;

            // Cập nhật khoảng thời gian hiển thị
            const startDisplay = start.toLocaleDateString('vi-VN');
            const endDisplay = end.toLocaleDateString('vi-VN');
            timeRangeElement.textContent = `(${startDisplay} - ${endDisplay})`;
        }

        /**
         * Hàm khởi tạo chính
         */
        function initReport() {
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            
            // Lấy giá trị ngày tháng từ input
            let startDate = startDateInput.value ? new Date(startDateInput.value) : null;
            let endDate = endDateInput.value ? new Date(endDateInput.value) : null;
            
            if (!startDate || !endDate) {
                alert('Vui lòng chọn cả "Từ ngày" và "Đến ngày".');
                return;
            }

            // Đặt thời gian End Date đến cuối ngày để bao gồm cả giao dịch cuối ngày đó
            endDate.setHours(23, 59, 59, 999);

            if (startDate > endDate) {
                alert('Ngày bắt đầu không được lớn hơn Ngày kết thúc.');
                return;
            }

            if (typeof getData !== 'function') {
                document.getElementById('reportTableBody').innerHTML = '<tr><td colspan="6" class="text-center text-danger fw-bold">Lỗi: Cần import main.js và đảm bảo hàm getData() tồn tại.</td></tr>';
                console.error("Lỗi: Hàm getData() không tồn tại. Vui lòng đảm bảo main.js đã được import.");
                return;
            }

            const reportData = generateInventoryReport(startDate, endDate);
            renderReport(reportData, startDate, endDate);
        }
        
        // Khởi tạo ngày mặc định khi tải trang
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const thirtyDaysAgo = new Date(today);
            thirtyDaysAgo.setDate(today.getDate() - 30);

            // Định dạng YYYY-MM-DD
            const formatDate = (date) => date.toISOString().split('T')[0];

            document.getElementById('startDate').value = formatDate(thirtyDaysAgo);
            document.getElementById('endDate').value = formatDate(today);
            
            // Tự động load báo cáo 30 ngày gần nhất khi vào trang
            // initReport();
        });
        </script>
    <script src="../bootstrap-5.3.2-dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/main.js"></script>
</body>
</html>