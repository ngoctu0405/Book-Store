<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Gi√° b√°n</title>

   <link rel="stylesheet" href="../bootstrap-5.3.2-dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../assets/css/admin_style.css">
</head>
<body>
    
    <aside class="sidebar d-flex flex-column vh-100">
        <div class="sidebar-header">
             Literary Haven - Admin
        </div>

        <ul class="nav nav-pills flex-column mb-auto">
            <li class="nav-item">
                <a href="dashboard.html" class="nav-link">B·∫£ng ƒëi·ªÅu khi·ªÉn</a>
            </li>
            <li class="nav-item">
                <a href="users.html" class="nav-link">Kh√°ch h√†ng</a>
            </li>
            <li class="nav-item">
                <a href="categories.html" class="nav-link">Lo·∫°i s·∫£n ph·∫©m</a>
            </li>
            <li class="nav-item">
                <a href="products.html" class="nav-link">S·∫£n ph·∫©m</a>
            </li>
            <li class="nav-item">
                <a href="purchase-orders.html" class="nav-link">Nh·∫≠p h√†ng</a>
            </li>
             <li class="nav-item">
                <a href="pricing.html" class="nav-link active">Qu·∫£n l√Ω gi√° b√°n</a>
            </li>
             <li class="nav-item">
                <a href="orders.html" class="nav-link">ƒê∆°n h√†ng</a>
            </li>
        </ul>
<<<<<<< HEAD
        <div class="sidebar-footer">
            <a href="#">ƒêƒÉng xu·∫•t</a>
=======
        
        <div class="mt-auto p-3">
             <ul class="nav nav-pills flex-column">
                <li class="nav-item"><a href="#" class="nav-link">Tr·ª£ gi√∫p</a></li>
                <li class="nav-item"><a href="#" class="nav-link">C√†i ƒë·∫∑t</a></li>
                <li class="nav-item"><a href="#" class="nav-link">M·∫≠t kh·∫©u</a></li>
                <li class="nav-item"><a href="index.html" class="nav-link">ƒêƒÉng xu·∫•t</a></li>
             </ul>
>>>>>>> 0f3068ca4757af65c3d35369f47d31497d4e0328
        </div>
    </aside>

    <main class="main-content">
        <header class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">
                <span class="navbar-brand">Qu·∫£n l√Ω Gi√° b√°n</span>
            </div>
        </header>

        <div class="container-fluid pt-4">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">‚öôÔ∏è Thi·∫øt l·∫≠p L·ª£i nhu·∫≠n chung (Theo lo·∫°i)</h5>
                </div>
                <div class="card-body">
                    <form id="category-profit-form" class="row g-3 align-items-end">
                        <div class="col-md-5">
                            <label for="profit-category" class="form-label">Lo·∫°i s·∫£n ph·∫©m</label>
                            <select id="profit-category" class="form-select">
                                <option selected value="">-- Ch·ªçn lo·∫°i SP --</option>
                                </select>
                        </div>
                        <div class="col-md-4">
                            <label for="profit-percent" class="form-label">T·ªâ l·ªá L·ª£i nhu·∫≠n (%)</label>
                            <input type="number" class="form-control" id="profit-percent" value="50" min="0" max="1000">
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary w-100">√Åp d·ª•ng L·ª£i nhu·∫≠n chung</button>
                        </div>
                    </form>
                    <small class="text-muted mt-2 d-block">L∆∞u √Ω: Thao t√°c n√†y s·∫Ω ghi ƒë√® t·ªâ l·ªá l·ª£i nhu·∫≠n hi·ªán t·∫°i c·ªßa t·∫•t c·∫£ s·∫£n ph·∫©m thu·ªôc lo·∫°i ƒë√£ ch·ªçn.</small>
                </div>
            </div>

            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center bg-info text-white">
                    <h5 class="mb-0">üìä Tinh ch·ªânh Gi√° b√°n (Theo s·∫£n ph·∫©m)</h5>
                    <button id="save-all-changes-btn" class="btn btn-success">üíæ L∆∞u t·∫•t c·∫£ thay ƒë·ªïi</button>
                </div>
                <div class="card-body">
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="search-input" placeholder="T√¨m ki·∫øm theo T√™n s·∫£n ph·∫©m, SKU...">
                        </div>
                        <div class="col-md-4">
                            <select id="filter-select" class="form-select">
                                <option selected value="">L·ªçc theo lo·∫°i s·∫£n ph·∫©m</option>
                                </select>
                        </div>
                        <div class="col-md-2">
                            <button id="search-button" class="btn btn-outline-secondary w-100">üîç Tra c·ª©u</button>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-hover table-bordered">
                            <thead class="table-light">
                                <tr>
                                    <th>T√™n s·∫£n ph·∫©m</th>
                                    <th>Lo·∫°i s·∫£n ph·∫©m</th>
                                    <th class="text-end">Gi√° v·ªën</th>
                                    <th class="text-center">T·ªâ l·ªá L·ª£i nhu·∫≠n (%)</th>
                                    <th class="text-end">Gi√° b√°n (T·∫°m t√≠nh)</th>
                                </tr>
                            </thead>
                            <tbody id="pricing-table-body">
                                <tr><td colspan="5" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="../assets/js/main.js"></script> 
    <script src="../bootstrap-5.3.2-dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ==========================================================
        // KHAI B√ÅO BI·∫æN V√Ä H√ÄM C∆† B·∫¢N
        // ==========================================================

        let currentProducts = []; // Danh s√°ch s·∫£n ph·∫©m ƒëang hi·ªÉn th·ªã

        // L·∫•y d·ªØ li·ªáu t·ª´ Local Storage ho·∫∑c d√πng SAMPLE n·∫øu ch∆∞a c√≥ 
        function getData() {
            try {
                // ∆Øu ti√™n l·∫•y d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l∆∞u tr·ªØ/c·∫≠p nh·∫≠t
                const data = JSON.parse(localStorage.getItem("bs_data"));
                
                // Fallback: N·∫øu kh√¥ng c√≥ trong LocalStorage, d√πng bi·∫øn SAMPLE t·ª´ main.js
                // ƒê·∫£m b·∫£o bi·∫øn SAMPLE t·ªìn t·∫°i
                const fallbackData = (typeof SAMPLE !== 'undefined' && SAMPLE.products) ? SAMPLE : { products: [] };
                
                // N·∫øu data.products r·ªóng, tr·∫£ v·ªÅ fallbackData
                return (data && data.products && data.products.length > 0) ? data : fallbackData; 
            } catch (e) {
                console.error("L·ªói khi ƒë·ªçc d·ªØ li·ªáu t·ª´ LocalStorage:", e);
                return (typeof SAMPLE !== 'undefined' && SAMPLE.products) ? SAMPLE : { products: [] };
            }
        }

        function saveData(data) {
            localStorage.setItem("bs_data", JSON.stringify(data));
        }

        // H√†m ƒë·ªãnh d·∫°ng ti·ªÅn t·ªá
        function formatCurrency(price) {
            // L√†m tr√≤n v√† ƒë·ªãnh d·∫°ng ti·ªÅn t·ªá Vi·ªát Nam
            return Math.round(price).toLocaleString("vi-VN") + "ƒë";
        }
        
        /**
         * T√≠nh to√°n gi√° b√°n d·ª±a tr√™n gi√° v·ªën v√† ph·∫ßn trƒÉm l·ª£i nhu·∫≠n
         * @param {number} costPrice - Gi√° v·ªën
         * @param {number} profitPercent - Ph·∫ßn trƒÉm l·ª£i nhu·∫≠n (0-100)
         * @returns {number} Gi√° b√°n
         */
        function calculateSellingPrice(costPrice, profitPercent) {
            if (profitPercent < 0) profitPercent = 0;
            return costPrice * (1 + profitPercent / 100);
        }

        // ==========================================================
        // 1. HI·ªÇN TH·ªä V√Ä L·ªåC S·∫¢N PH·∫®M (Y√äU C·∫¶U 2: HI·ªÇN TH·ªä & TRA C·ª®U)
        // ==========================================================

        /**
         * L·ªçc v√† render danh s√°ch s·∫£n ph·∫©m v√†o b·∫£ng
         * @param {Array} products - Danh s√°ch s·∫£n ph·∫©m ƒë·ªÉ render
         */
        function renderPricingTable(products) {
            const tableBody = document.getElementById('pricing-table-body');
            if (!tableBody) return;

            tableBody.innerHTML = '';
            currentProducts = products; // C·∫≠p nh·∫≠t danh s√°ch hi·ªán t·∫°i

            if (products.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o.</td></tr>';
                return;
            }

            products.forEach(p => {
                // Gi√° v·ªën l√† p.price. L·ª£i nhu·∫≠n m·∫∑c ƒë·ªãnh l√† 50% n·∫øu ch∆∞a ƒë∆∞·ª£c l∆∞u
                // Y√äU C·∫¶U 2: Hi·ªÉn th·ªã % L·ª£i nhu·∫≠n
                const profitPercent = p.profitPercent != null ? p.profitPercent : 50; 
                const sellingPrice = calculateSellingPrice(p.price, profitPercent);

                const row = document.createElement('tr');
                row.setAttribute('data-product-id', p.id); 
                row.innerHTML = `
                    <td>${p.name}</td>
                    <td>${p.subcategory || p.category}</td>
                    <td class="text-end">${formatCurrency(p.price)}</td>
                    <td class="text-center">
                        <input type="number" class="profit-input form-control text-center" value="${profitPercent}" min="0" max="1000" style="width: 80px; display: inline-block;">
                    </td>
                    <td class="text-end fw-bold selling-price">${formatCurrency(sellingPrice)}</td>
                `;
                tableBody.appendChild(row);
            });

            // G·∫Øn s·ª± ki·ªán l·∫Øng nghe thay ƒë·ªïi input sau khi render
            attachProfitChangeListener();
        }

        /**
         * X·ª≠ l√Ω s·ª± ki·ªán t√¨m ki·∫øm v√† l·ªçc s·∫£n ph·∫©m (Y√äU C·∫¶U 2: TRA C·ª®U)
         */
        function handleSearchAndFilter() {
            const data = getData();
            const allProducts = data.products;

            const searchInput = document.getElementById('search-input').value.toLowerCase().trim();
            const filterSelect = document.getElementById('filter-select').value;
            
            let filteredProducts = allProducts;

            // 1. L·ªçc theo lo·∫°i s·∫£n ph·∫©m (subcategory ho·∫∑c category)
            if (filterSelect) {
                filteredProducts = filteredProducts.filter(p => p.subcategory === filterSelect || p.category === filterSelect);
            }
            
            // 2. L·ªçc theo t√™n ho·∫∑c SKU
            if (searchInput) {
                filteredProducts = filteredProducts.filter(p => 
                    p.name.toLowerCase().includes(searchInput) || 
                    (p.sku && p.sku.toLowerCase().includes(searchInput))
                );
            }

            renderPricingTable(filteredProducts);
        }

        // ==========================================================
        // 2. C·∫¨P NH·∫¨T GI√Å B√ÅN TR·ª∞C TI·∫æP (Y√äU C·∫¶U 1: S·ª¨A)
        // ==========================================================

        /**
         * G·∫Øn s·ª± ki·ªán l·∫Øng nghe thay ƒë·ªïi cho input l·ª£i nhu·∫≠n
         */
        function attachProfitChangeListener() {
            document.querySelectorAll('.profit-input').forEach(input => {
                input.removeEventListener('input', updateSellingPrice); 
                input.addEventListener('input', updateSellingPrice);
            });
        }

        /**
         * C·∫≠p nh·∫≠t gi√° b√°n t·∫°m t√≠nh khi thay ƒë·ªïi % L·ª£i nhu·∫≠n
         */
        function updateSellingPrice(e) {
            const input = e.target;
            const row = input.closest('tr');
            const productId = Number(row.getAttribute('data-product-id'));
            let profitPercent = Number(input.value);

            const product = currentProducts.find(p => p.id === productId);
            if (!product) return;

            const costPrice = product.price;

            // T√≠nh to√°n gi√° b√°n m·ªõi
            const newSellingPrice = calculateSellingPrice(costPrice, profitPercent);

            // C·∫≠p nh·∫≠t gi√° b√°n hi·ªÉn th·ªã
            row.querySelector('.selling-price').textContent = formatCurrency(newSellingPrice);
            
            // ƒê√°nh d·∫•u d√≤ng ƒë√£ thay ƒë·ªïi
            row.classList.add('table-warning');
        }


        // ==========================================================
        // 3. L∆ØU THAY ƒê·ªîI V√Ä √ÅP D·ª§NG CHUNG
        // ==========================================================

        /**
         * X·ª≠ l√Ω khi √°p d·ª•ng t·ªâ l·ªá l·ª£i nhu·∫≠n chung cho m·ªôt lo·∫°i s·∫£n ph·∫©m
         */
        function handleApplyCategoryProfit(e) {
            e.preventDefault();
            const categorySelect = document.getElementById('profit-category');
            const profitInput = document.getElementById('profit-percent');
            
            const selectedCategory = categorySelect.value;
            const profitPercent = Number(profitInput.value);

            if (!selectedCategory) {
                alert('Vui l√≤ng ch·ªçn m·ªôt lo·∫°i s·∫£n ph·∫©m.');
                return;
            }

            if (isNaN(profitPercent) || profitPercent < 0) {
                alert('T·ªâ l·ªá l·ª£i nhu·∫≠n kh√¥ng h·ª£p l·ªá. Vui l√≤ng nh·∫≠p s·ªë >= 0.');
                return;
            }

            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën √°p d·ª•ng T·ªâ l·ªá L·ª£i nhu·∫≠n ${profitPercent}% cho T·∫§T C·∫¢ s·∫£n ph·∫©m thu·ªôc lo·∫°i "${selectedCategory}" kh√¥ng?`)) {
                return;
            }

            const data = getData();
            let count = 0;

            const updatedProducts = data.products.map(p => {
                if (p.category === selectedCategory || p.subcategory === selectedCategory) {
                    p.profitPercent = profitPercent; 
                    count++;
                    return p;
                }
                return p;
            });

            data.products = updatedProducts;
            saveData(data);
            
            alert(`‚úÖ ƒê√£ √°p d·ª•ng ${profitPercent}% l·ª£i nhu·∫≠n cho ${count} s·∫£n ph·∫©m thu·ªôc lo·∫°i "${selectedCategory}".`);
            
            handleSearchAndFilter();
        }


        /**
         * X·ª≠ l√Ω l∆∞u t·∫•t c·∫£ thay ƒë·ªïi t·ª´ b·∫£ng v√†o LocalStorage
         */
        function handleSaveAllChanges() {
            const data = getData();
            let changesCount = 0;
            const rows = document.querySelectorAll('#pricing-table-body tr[data-product-id]');
            
            if (rows.length === 0) {
                alert('Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ƒë·ªÉ l∆∞u.');
                return;
            }

            rows.forEach(row => {
                const productId = Number(row.getAttribute('data-product-id'));
                const profitInput = row.querySelector('.profit-input');
                
                if (!profitInput) return;

                const newProfitPercent = Number(profitInput.value);

                const productIndex = data.products.findIndex(p => p.id === productId);

                if (productIndex > -1) {
                    const currentProduct = data.products[productIndex];
                    
                    if (currentProduct.profitPercent !== newProfitPercent) {
                         data.products[productIndex].profitPercent = newProfitPercent;
                         changesCount++;
                    }
                }
            });

            if (changesCount > 0) {
                saveData(data);
                alert(`‚úÖ ƒê√£ l∆∞u th√†nh c√¥ng ${changesCount} thay ƒë·ªïi v·ªÅ t·ªâ l·ªá l·ª£i nhu·∫≠n.`);
                document.querySelectorAll('#pricing-table-body tr').forEach(row => row.classList.remove('table-warning'));
            } else {
                alert('Kh√¥ng c√≥ thay ƒë·ªïi n√†o ƒë·ªÉ l∆∞u.');
            }
        }


        // ==========================================================
        // 4. KH·ªûI T·∫†O
        // ==========================================================

        /**
         * ƒêi·ªÅn c√°c lo·∫°i s·∫£n ph·∫©m (subcategory ∆∞u ti√™n, sau ƒë√≥ l√† category) v√†o c√°c dropdown
         */
        function populateCategoryDropdowns() {
            const data = getData();
            const categories = new Set();

            data.products.forEach(p => {
                // L·∫•y subcategory n·∫øu c√≥, ng∆∞·ª£c l·∫°i l·∫•y category (ch·ªâ l·∫•y unique values)
                const catName = p.subcategory || p.category;
                if (catName) {
                    categories.add(catName);
                }
            });

            const categoryArray = Array.from(categories).sort();
            
            const profitCategorySelect = document.getElementById('profit-category');
            const filterSelect = document.getElementById('filter-select');

            categoryArray.forEach(cat => {
                // Th√™m v√†o dropdown L·ª£i nhu·∫≠n chung
                if (profitCategorySelect) {
                    const option1 = document.createElement('option');
                    option1.value = cat; 
                    option1.textContent = cat;
                    profitCategorySelect.appendChild(option1);
                }

                // Th√™m v√†o dropdown L·ªçc s·∫£n ph·∫©m
                 if (filterSelect) {
                    const option2 = document.createElement('option');
                    option2.value = cat;
                    option2.textContent = cat;
                    filterSelect.appendChild(option2);
                }
            });
        }


        function initAdminPricing() {
            // 1. ƒêi·ªÅn d·ªØ li·ªáu v√†o dropdown
            populateCategoryDropdowns();
            
            // 2. T·∫£i danh s√°ch s·∫£n ph·∫©m ban ƒë·∫ßu
            handleSearchAndFilter(); 
            
            // 3. G·∫Øn s·ª± ki·ªán cho form Thi·∫øt l·∫≠p L·ª£i nhu·∫≠n chung
            const categoryProfitForm = document.getElementById('category-profit-form');
            if (categoryProfitForm) {
                categoryProfitForm.addEventListener('submit', handleApplyCategoryProfit);
            }
            
            // 4. G·∫Øn s·ª± ki·ªán cho n√∫t Tra c·ª©u
            const searchButton = document.getElementById('search-button');
            if (searchButton) {
                searchButton.addEventListener('click', handleSearchAndFilter);
            }
            
            // 5. G·∫Øn s·ª± ki·ªán cho form t√¨m ki·∫øm (cho ph√©p nh·∫•n Enter)
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleSearchAndFilter();
                    }
                });
            }

            // 6. G·∫Øn s·ª± ki·ªán cho n√∫t L∆∞u t·∫•t c·∫£ thay ƒë·ªïi
            const saveButton = document.getElementById('save-all-changes-btn');
            if (saveButton) {
                saveButton.addEventListener('click', handleSaveAllChanges);
            }
        }

        // Kh·ªüi ch·∫°y khi DOM ƒë√£ s·∫µn s√†ng
        document.addEventListener('DOMContentLoaded', initAdminPricing);
    </script>
</body>
</html>