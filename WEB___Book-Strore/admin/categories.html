<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Loại Sản phẩm</title>
     <link rel="stylesheet" href="../bootstrap-5.3.2-dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../assets/css/admin_style.css">
</head>
<body>
    
    <aside class="sidebar d-flex flex-column vh-100">
        <div class="sidebar-header">
             Literary Haven - Admin
        </div>

        <ul class="nav nav-pills flex-column mb-auto">
            <li class="nav-item">
                <a href="dashboard.html" class="nav-link">Bảng điều khiển</a>
            </li>
            <li class="nav-item">
                <a href="users.html" class="nav-link">Khách hàng</a>
            </li>
            <li class="nav-item">
                <a href="categories.html" class="nav-link">Loại sản phẩm</a>
            </li>
            <li class="nav-item">
                <a href="products.html" class="nav-link">Sản phẩm</a>
            </li>
            <li class="nav-item">
                <a href="purchase-orders.html" class="nav-link">Nhập hàng</a>
            </li>
             <li class="nav-item">
                <a href="pricing.html" class="nav-link">Quản lý giá</a>
            </li>
            <li class="nav-item">
                <a href="orders.html" class="nav-link">Đơn hàng</a>
            </li>
            <li class="nav-item">
                <a href="inventory.html" class="nav-link">Tồn kho</a>
            </li>
            <li class="nav-item">
                <a href="reports.html" class="nav-link">Báo cáo</a>
            </li>
        </ul>
        
        <div class="mt-auto p-3">
             <ul class="nav nav-pills flex-column">
                <li class="nav-item"><a href="#" class="nav-link">Trợ giúp</a></li>
                <li class="nav-item"><a href="#" class="nav-link">Cài đặt</a></li>
                <li class="nav-item"><a href="#" class="nav-link">Mật khẩu</a></li>
                <li class="nav-item"><a href="index.html" class="nav-link">Đăng xuất</a></li>
             </ul>
        </div>
    </aside>

    <main class="main-content">
        <header class="top-bar p-3 d-flex justify-content-between align-items-center">
            <form class="search-bar d-flex align-items-center">
                <input class="form-control" type="search" placeholder="Tìm kiếm...">
            </form>
            <div class="profile-area d-flex align-items-center">
                <div class="profile-pic ms-3"></div>
            </div>
        </header>

        <div class="page-content p-4">
            <h1 class="mb-4">Quản lý Loại Sản phẩm (Yêu cầu 3)</h1>

            <div class="row g-4">
                <div class="col-md-4">
                    <div class="form-container p-4">
                        <h3 class="h5 mb-3" id="category-form-title">Thêm loại mới</h3>
                        <form id="categoryForm">
                            <div class="mb-3">
                                <label for="category-name" class="form-label">Tên loại sản phẩm</label>
                                <input type="text" class="form-control" id="category-name" required>
                            </div>
                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary">Hủy</button>
                                <button type="submit" class="btn btn-primary ms-2">Lưu</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="h5 mb-0">Danh sách loại sản phẩm</h3>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Tên loại</th>
                                            <th>Trạng thái</th>
                                            <th>Hành động</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <script src="../bootstrap-5.3.2-dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/admin_main.js"></script>
<script>
    // --- KHAI BÁO VÀ KHỞI TẠO DỮ LIỆU ---
    const CATEGORIES_STORAGE_KEY = 'admin_categories_data';

    // Dữ liệu mặc định cho lần chạy đầu tiên (để có sẵn menu bên user)
    const defaultCategories = [
        { name: 'Văn học', subcategories: ['Tiểu thuyết', 'Truyện ngắn', 'Thơ'], status: 'active' },
        { name: 'Kinh tế', subcategories: ['Quản trị', 'Tài chính', 'Marketing'], status: 'active' },
        { name: 'Thiếu nhi', subcategories: ['Truyện tranh', 'Giáo dục'], status: 'active' },
        { name: 'Giáo khoa', subcategories: ['Cấp 1', 'Cấp 2', 'Cấp 3'], status: 'active' }
    ];

    /**
     * Lấy danh sách categories từ Local Storage, nếu chưa có thì dùng mặc định
     */
    function getCategories() {
        const storedData = localStorage.getItem(CATEGORIES_STORAGE_KEY);
        if (storedData) {
            try {
                return JSON.parse(storedData);
            } catch (e) {
                console.error("Lỗi khi phân tích dữ liệu categories từ localStorage:", e);
                return defaultCategories;
            }
        }
        return defaultCategories;
    }

    /**
     * Lưu danh sách categories vào Local Storage
     */
    function saveCategories(categories) {
        localStorage.setItem(CATEGORIES_STORAGE_KEY, JSON.stringify(categories));
    }

    // --- LOGIC FORM VÀ BẢNG ---
    const categoryForm = document.getElementById('categoryForm');
    const categoryNameInput = document.getElementById('category-name');
    const tableBody = document.querySelector('.table tbody');
    const formTitle = document.getElementById('category-form-title');
    let categories = getCategories();
    let isEditing = false;
    let editingIndex = -1;

    /**
     * Render danh sách categories ra bảng
     */
    function renderCategories() {
        // Lần đầu tiên, đảm bảo dữ liệu mặc định được lưu lại
        saveCategories(categories);
        
        tableBody.innerHTML = ''; // Xóa nội dung cũ
        
        categories.forEach((cat, index) => {
            const statusClass = cat.status === 'active' ? 'delivered' : 'pending';
            const statusText = cat.status === 'active' ? 'Đang hiển thị' : 'Đã ẩn';
            const actionButton = cat.status === 'active' 
                ? `<button class="btn btn-sm btn-outline-danger" onclick="toggleCategoryStatus(${index})">Ẩn</button>`
                : `<button class="btn btn-sm btn-outline-success" onclick="toggleCategoryStatus(${index})">Hiện</button>`;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${cat.name}</td>
                <td><span class="status ${statusClass}">${statusText}</span></td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="editCategory(${index})">Sửa</button>
                    ${actionButton}
                </td>
            `;
            tableBody.appendChild(row);
        });
    }

    /**
     * Xử lý khi submit form: Thêm hoặc Sửa category
     */
    categoryForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const name = categoryNameInput.value.trim();
        if (!name) return;

        // Chuẩn hóa tên (ví dụ: viết hoa chữ cái đầu)
        const newName = name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();

        if (isEditing) {
            // Logic Sửa
            categories[editingIndex].name = newName;
            
            // Đặt lại trạng thái form
            isEditing = false;
            editingIndex = -1;
            categoryForm.querySelector('button[type="submit"]').textContent = 'Lưu';
            formTitle.textContent = 'Thêm loại mới';
            // Không cần reset nút Hủy/Hủy sửa nếu dùng button type="submit"
        } else {
            // Logic Thêm mới
            const newCategory = {
                name: newName,
                subcategories: [`Tất cả ${newName}`], // Gán subcategory mặc định
                status: 'active'
            };
            categories.push(newCategory);
        }

        categoryNameInput.value = '';
        saveCategories(categories);
        renderCategories();
    });

    /**
     * Chuyển chế độ sang Sửa (Edit)
     */
    window.editCategory = function(index) {
        const cat = categories[index];
        isEditing = true;
        editingIndex = index;
        categoryNameInput.value = cat.name;
        formTitle.textContent = `Sửa loại: ${cat.name}`;
        categoryForm.querySelector('button[type="submit"]').textContent = 'Cập nhật';
        categoryForm.querySelector('.btn-secondary').textContent = 'Hủy sửa';
    }
    
    /**
     * Chuyển đổi trạng thái category (Ẩn/Hiện)
     */
    window.toggleCategoryStatus = function(index) {
        const currentStatus = categories[index].status;
        categories[index].status = currentStatus === 'active' ? 'hidden' : 'active';
        saveCategories(categories);
        renderCategories();
    }
    
    /**
     * Xử lý nút Hủy
     */
    document.querySelector('.form-actions .btn-secondary').addEventListener('click', function() {
        if (isEditing) {
            // Hủy chế độ chỉnh sửa
            isEditing = false;
            editingIndex = -1;
            categoryNameInput.value = '';
            formTitle.textContent = 'Thêm loại mới';
            categoryForm.querySelector('button[type="submit"]').textContent = 'Lưu';
            this.textContent = 'Hủy';
        } else {
            // Xóa nội dung input
            categoryNameInput.value = '';
        }
    });

    // Khởi tạo bảng khi tải trang
    document.addEventListener('DOMContentLoaded', renderCategories);
</script>
</body>
</html>