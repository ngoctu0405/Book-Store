<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω S·∫£n ph·∫©m</title>

     <link rel="stylesheet" href="../bootstrap-5.3.2-dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../assets/css/admin_style.css">
    
    <style>
        /* CSS n·ªôi b·ªô ch·ªâ ƒë·ªÉ ƒë·ªãnh d·∫°ng ·∫£nh trong b·∫£ng */
        .product-image-thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
        }

        /* ƒê·ªãnh d·∫°ng tr·∫°ng th√°i s·∫£n ph·∫©m */
        .status-tag {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-active {
            background-color: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* CSS cho n√∫t x√≥a ·∫£nh */
        .image-preview-container {
            position: relative;
            display: inline-block;
        }
        .remove-image-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #dc3545;
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            line-height: 1;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        
        /* ƒê·∫£m b·∫£o tr∆∞·ªùng gi√° b√°n t√≠nh to√°n n·ªïi b·∫≠t v√† kh√°c bi·ªát */
        #product-price {
            background-color: #e9f5ff; 
            font-weight: bold;
            color: #0d6efd;
        }
    </style>
</head>
<body>
    
    <aside class="sidebar d-flex flex-column vh-100">
        <div class="sidebar-header">
            Literary Haven
        </div>

        <ul class="nav nav-pills flex-column mb-auto">
            <li class="nav-item">
                <a href="dashboard.html" class="nav-link ">
                    <span class="nav-icon">‚óà</span>
                    <span>B·∫£ng ƒëi·ªÅu khi·ªÉn</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="users.html" class="nav-link">
                    <span class="nav-icon">‚óâ</span>
                    <span>Kh√°ch h√†ng</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="categories.html" class="nav-link">
                    <span class="nav-icon">‚ó´</span>
                    <span>Lo·∫°i s·∫£n ph·∫©m</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="products.html" class="nav-link">
                    <span class="nav-icon">‚ó™</span>
                    <span>S·∫£n ph·∫©m</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="purchase-orders.html" class="nav-link">
                    <span class="nav-icon">‚ó©</span>
                    <span>Nh·∫≠p h√†ng</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="pricing.html" class="nav-link">
                    <span class="nav-icon">‚óé</span>
                    <span>Qu·∫£n l√Ω gi√°</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="orders.html" class="nav-link">
                    <span class="nav-icon">‚óß</span>
                    <span>ƒê∆°n h√†ng</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="inventory.html" class="nav-link">
                    <span class="nav-icon">‚ó®</span>
                    <span>T·ªìn kho</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="reports.html" class="nav-link">
                    <span class="nav-icon">‚óî</span>
                    <span>B√°o c√°o</span>
                </a>
            </li>
        </ul>
        
        <div class="mt-auto p-3">
            <a href="index.html" class="logout-link">
                <span>‚óÄ</span>
                <span>ƒêƒÉng xu·∫•t</span>
            </a>
        </div>
    </aside>

    <main class="main-content">
        <div class="container-fluid py-4">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h1 class="h3 mb-0">Qu·∫£n l√Ω S·∫£n ph·∫©m</h1>
                    <button class="btn btn-primary" onclick="openProductModal(null)">
                        + Th√™m S·∫£n ph·∫©m
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped">
                            <thead>
                                <tr>
                                    <th>M√£ ID</th>
                                    <th>M√£ SKU</th>
                                    <th>T√™n S·∫£n ph·∫©m</th>
                                    <th>Lo·∫°i</th>
                                    <th>Gi√° (VND)</th>
                                    <th>T·ªìn kho</th>
                                    <th>Hi·ªán tr·∫°ng</th>
                                    <th>H√¨nh ·∫¢nh</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="productListTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalLabel">Th√™m S·∫£n ph·∫©m M·ªõi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="product-id">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="product-sku" class="form-label">M√£ ID</label>
                                    <input type="text" class="form-control" id="product-id" required>
                                </div>
                                <div class="mb-3">
                                    <label for="product-sku" class="form-label">M√£ SKU</label>
                                    <input type="text" class="form-control" id="product-sku" required>
                                </div>
                                <div class="mb-3">
                                    <label for="product-name" class="form-label">T√™n S·∫£n ph·∫©m</label>
                                    <input type="text" class="form-control" id="product-name" required>
                                </div><!-- ‚úÖ TH√äM TR∆Ø·ªúNG T√ÅC GI·∫¢ -->
<div class="mb-3">
    <label for="product-author" class="form-label">T√°c gi·∫£</label>
    <input type="text" class="form-control" id="product-author" placeholder="Nh·∫≠p t√™n t√°c gi·∫£">
</div>
                                
                                <div class="mb-3">
                                    <label for="product-category" class="form-label">Lo·∫°i (Category)</label>
                                    <input type="text" class="form-control" id="product-category" required placeholder="V√≠ d·ª•: VƒÉn h·ªçc">
                                </div>
                                <div class="mb-3">
                                    <label for="product-subcategory" class="form-label">Ph√¢n lo·∫°i chi ti·∫øt (Subcategory)</label>
                                    <input type="text" class="form-control" id="product-subcategory" required placeholder="V√≠ d·ª•: Ti·ªÉu thuy·∫øt">
                                </div>
                                <div class="mb-3">
                                    <label for="product-unit" class="form-label">ƒê∆°n v·ªã t√≠nh</label>
                                    <input type="text" class="form-control" id="product-unit" required placeholder="V√≠ d·ª•: Cu·ªën, Quy·ªÉn">
                                </div>
                            </div>
                            <div class="col-md-6">
                                
                                <div class="mb-3">
                                    <label for="product-costPrice" class="form-label">üí∞ Gi√° g·ªëc (VND)</label>
                                    <input type="number" class="form-control" id="product-costPrice" min="0" value="0" oninput="calculateSellingPrice()">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="product-profitMargin" class="form-label">T·ªâ l·ªá l·ª£i nhu·∫≠n mong mu·ªën (%)</label>
                                    <input type="number" class="form-control" id="product-profitMargin" min="0" max="100" value="0" oninput="calculateSellingPrice()">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="product-price" class="form-label">üíµ Gi√° b√°n (t√≠nh to√°n, VND)</label>
                                    <input type="number" class="form-control" id="product-price" min="0" value="0" readonly>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="product-qty" class="form-label">S·ªë l∆∞·ª£ng (T·ªìn kho)</label>
                                    <input type="number" class="form-control" id="product-qty" required min="0" value="0">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="product-status" class="form-label">Hi·ªán tr·∫°ng</label>
                                    <select class="form-select" id="product-status" required>
                                        <option value="active">ƒêang b√°n</option>
                                        <option value="inactive">D·ª´ng b√°n (H·∫øt b√°n/·∫®n)</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="product-image-upload" class="form-label">H√¨nh ·∫£nh</label>
                                    <input class="form-control" type="file" id="product-image-upload" accept="image/*">
                                    <div id="image-preview-area" class="mt-2">
                                        </div>
                                    <input type="hidden" id="product-img-path"> </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="product-desc" class="form-label">M√¥ t·∫£</label>
                            <textarea class="form-control" id="product-desc" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-primary" onclick="handleSaveProduct()">L∆∞u S·∫£n ph·∫©m</button>
                </div>
            </div>
        </div>
    </div>

   <script src="../bootstrap-5.3.2-dist/js/bootstrap.bundle.min.js"></script>
   <script src="assets/js/main.js"></script>
   <script>
/* =================== H√ÄM TI·ªÜN √çCH =================== */
function getData() {
    return JSON.parse(localStorage.getItem("bs_data")) || { products: [] };
}
function saveData(data) {
    localStorage.setItem("bs_data", JSON.stringify(data));
}

/* =================== HI·ªÇN TH·ªä DANH S√ÅCH =================== */
function renderProductList() {
    const list = getData().products;
    const tbody = document.getElementById("productListTableBody");
    tbody.innerHTML = list.map(p => `
        <tr>
            <td>${p.id}</td>
            <td>${p.sku}</td>
            <td>${p.name}</td>
            <td>${p.category} ‚Üí ${p.subcategory}</td>
            <td>${p.price.toLocaleString("vi-VN")}‚Ç´</td>
            <td>${p.qty}</td>
            <td>
                <span class="status-tag ${p.status === "active" ? "status-active" : "status-inactive"}">
                    ${p.status === "active" ? "ƒêANG B√ÅN" : "D·ª™NG B√ÅN"}
                </span>
            </td>
            <td><img src="${p.img}" class="product-image-thumbnail"></td>
            <td>
                <button class="btn btn-sm btn-warning" onclick="openProductModal(${p.id})">S·ª≠a</button>
            </td>
        </tr>
    `).join("");
}

/* =================== X·ª¨ L√ù ·∫¢NH =================== */
function handleImageUpload(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
        document.getElementById("image-preview-area").innerHTML = `
            <div class="image-preview-container">
                <img src="${ev.target.result}" class="product-image-thumbnail">
                <span class="remove-image-btn" onclick="removeImage()">√ó</span>
            </div>`;
        document.getElementById("product-img-path").value = `images/${file.name}`;
    };
    reader.readAsDataURL(file);
}
function removeImage() {
    document.getElementById("product-image-upload").value = "";
    document.getElementById("product-img-path").value = "";
    document.getElementById("image-preview-area").innerHTML = "";
}

/* =================== T√çNH GI√Å B√ÅN =================== */
function calculateSellingPrice() {
    const cost = parseFloat(document.getElementById("product-costPrice").value) || 0;
    const margin = parseFloat(document.getElementById("product-profitMargin").value) || 0;
    const selling = cost + (cost * margin / 100);
    document.getElementById("product-price").value = selling.toFixed(0);
}

/* =================== MODAL TH√äM / S·ª¨A =================== */
function openProductModal(id = null) {
    const modal = new bootstrap.Modal(document.getElementById("productModal"));
    const form = document.getElementById("productForm");
    form.reset();
    removeImage();
    document.getElementById("product-id").readOnly = true; // ID t·ª± ƒë·ªông, kh√¥ng nh·∫≠p tay

    if (id) {
        // ======== S·ª¨A S·∫¢N PH·∫®M ========
        const p = getData().products.find(x => x.id == id);
        if (!p) return alert("Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m!");
        document.getElementById("productModalLabel").innerText = "S·ª≠a s·∫£n ph·∫©m";
        document.getElementById("product-id").value = p.id;
        document.getElementById("product-sku").value = p.sku;
        document.getElementById("product-name").value = p.name;
        document.getElementById("product-category").value = p.category;
        document.getElementById("product-subcategory").value = p.subcategory;
        document.getElementById("product-unit").value = p.unit || "quy·ªÉn";
        document.getElementById("product-costPrice").value = p.costPrice || p.price;
        document.getElementById("product-profitMargin").value = p.profitMargin || 0;
        document.getElementById("product-price").value = p.price;
        document.getElementById("product-qty").value = p.qty;
        document.getElementById("product-status").value = p.status || "active";
        document.getElementById("product-desc").value = p.desc;
        if (p.img) renderImagePreview(p.img);
    } else {
        // ======== TH√äM S·∫¢N PH·∫®M M·ªöI ========
        document.getElementById("productModalLabel").innerText = "Th√™m s·∫£n ph·∫©m m·ªõi";
        const data = getData();
        const nextId = data.products.length > 0 ? Math.max(...data.products.map(x => parseInt(x.id))) + 1 : 1;
        document.getElementById("product-id").value = nextId;
        document.getElementById("product-unit").value = "quy·ªÉn";
        document.getElementById("product-status").value = "active"; // ‚úÖ M·∫∑c ƒë·ªãnh ƒëang b√°n
    }
    modal.show();
}
function renderImagePreview(path) {
    document.getElementById("image-preview-area").innerHTML = `
        <div class="image-preview-container">
            <img src="${path}" class="product-image-thumbnail">
            <span class="remove-image-btn" onclick="removeImage()">√ó</span>
        </div>`;
    document.getElementById("product-img-path").value = path;
}

function handleSaveProduct() {
    const id = parseInt(document.getElementById("product-id").value.trim()); // ‚úÖ ƒê·ªîI TH√ÄNH S·ªê
    const sku = document.getElementById("product-sku").value.trim();
    const name = document.getElementById("product-name").value.trim();
    const category = document.getElementById("product-category").value.trim();
    const subcategory = document.getElementById("product-subcategory").value.trim();
    const desc = document.getElementById("product-desc").value.trim();
    const unit = document.getElementById("product-unit").value.trim() || "quy·ªÉn";
    const qty = parseInt(document.getElementById("product-qty").value) || 0;
    const img = document.getElementById("product-img-path").value || "images/default.jpg"; // ‚úÖ TH√äM M·∫∂C ƒê·ªäNH
    const price = parseFloat(document.getElementById("product-price").value) || 0;
    const profitMargin = parseFloat(document.getElementById("product-profitMargin").value) || 0;
    const costPrice = parseFloat(document.getElementById("product-costPrice").value) || 0;
    const status = document.getElementById("product-status").value || "active";
    const author = document.getElementById("product-author")?.value?.trim() || "ƒêang c·∫≠p nh·∫≠t"; // ‚úÖ TH√äM T√ÅC GI·∫¢

    if (!sku || !name || !category) {
        alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
        return;
    }

    const data = getData();
    const existingIndex = data.products.findIndex(p => p.id === id); // ‚úÖ D√ôNG === THAY V√å ==
    
    // ‚úÖ T·∫†O ƒê·ªêI T∆Ø·ª¢NG S·∫¢N PH·∫®M ƒê·∫¶Y ƒê·ª¶
    const newProduct = { 
        id: id, 
        sku: sku, 
        name: name, 
        author: author,
        category: category, 
        subcategory: subcategory, 
        desc: desc, 
        unit: unit, 
        qty: qty, 
        img: img, 
        price: price, 
        profitMargin: profitMargin, 
        costPrice: costPrice, 
        status: status 
    };

    if (existingIndex >= 0) {
        // ‚úÖ C·∫¨P NH·∫¨T S·∫¢N PH·∫®M C≈®
        data.products[existingIndex] = newProduct;
        alert("‚úÖ C·∫≠p nh·∫≠t s·∫£n ph·∫©m th√†nh c√¥ng!");
    } else {
        // ‚úÖ TH√äM S·∫¢N PH·∫®M M·ªöI
        data.products.push(newProduct);
        alert("‚úÖ Th√™m s·∫£n ph·∫©m m·ªõi th√†nh c√¥ng!");
    }

    // ‚úÖ L∆ØU V√ÄO LOCALSTORAGE
    saveData(data);
    
    console.log("üì¶ D·ªØ li·ªáu ƒë√£ l∆∞u:", data); // ‚úÖ DEBUG
    console.log("üîç Ki·ªÉm tra localStorage:", localStorage.getItem("bs_data")); // ‚úÖ DEBUG
    
    bootstrap.Modal.getInstance(document.getElementById("productModal")).hide();
    renderProductList();
}

/* =================== KH·ªûI ƒê·ªòNG =================== */
document.addEventListener("DOMContentLoaded", () => {
    renderProductList();
    document.getElementById("product-image-upload").addEventListener("change", handleImageUpload);
});
function openProductModal(id = null) {
    const modal = new bootstrap.Modal(document.getElementById("productModal"));
    const form = document.getElementById("productForm");
    form.reset();
    removeImage();
    document.getElementById("product-id").readOnly = true;

    if (id) {
        const p = getData().products.find(x => x.id == id);
        if (!p) return alert("Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m!");
        document.getElementById("productModalLabel").innerText = "S·ª≠a s·∫£n ph·∫©m";
        document.getElementById("product-id").value = p.id;
        document.getElementById("product-sku").value = p.sku;
        document.getElementById("product-name").value = p.name;
        document.getElementById("product-author").value = p.author || ""; // ‚úÖ TH√äM D√íNG N√ÄY
        document.getElementById("product-category").value = p.category;
        document.getElementById("product-subcategory").value = p.subcategory;
        document.getElementById("product-unit").value = p.unit || "quy·ªÉn";
        document.getElementById("product-costPrice").value = p.costPrice || p.price;
        document.getElementById("product-profitMargin").value = p.profitMargin || 0;
        document.getElementById("product-price").value = p.price;
        document.getElementById("product-qty").value = p.qty;
        document.getElementById("product-status").value = p.status || "active";
        document.getElementById("product-desc").value = p.desc;
        if (p.img) renderImagePreview(p.img);
    } else {
        document.getElementById("productModalLabel").innerText = "Th√™m s·∫£n ph·∫©m m·ªõi";
        const data = getData();
        const nextId = data.products.length > 0 ? Math.max(...data.products.map(x => parseInt(x.id))) + 1 : 1;
        document.getElementById("product-id").value = nextId;
        document.getElementById("product-unit").value = "quy·ªÉn";
        document.getElementById("product-status").value = "active";
    }
    modal.show();
}


</script>


 
</body>
</html>