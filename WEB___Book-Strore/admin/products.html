<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω S·∫£n ph·∫©m</title>

     <link rel="stylesheet" href="../bootstrap-5.3.2-dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="../assets/css/admin_style.css">
    
    <style>
        /* CSS n·ªôi b·ªô ch·ªâ ƒë·ªÉ ƒë·ªãnh d·∫°ng ·∫£nh trong b·∫£ng */
        .product-image-thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 4px;
        }

        /* ƒê·ªãnh d·∫°ng tr·∫°ng th√°i s·∫£n ph·∫©m */
        .status-tag {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-active {
            background-color: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* CSS cho n√∫t x√≥a ·∫£nh */
        .image-preview-container {
            position: relative;
            display: inline-block;
        }
        .remove-image-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #dc3545;
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            line-height: 1;
            text-align: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        
        /* ƒê·∫£m b·∫£o tr∆∞·ªùng gi√° b√°n t√≠nh to√°n n·ªïi b·∫≠t v√† kh√°c bi·ªát */
        #product-price {
            background-color: #e9f5ff; 
            font-weight: bold;
            color: #0d6efd;
        }
    </style>
</head>
<body>
    
    <aside class="sidebar d-flex flex-column vh-100">
        <div class="sidebar-header">
           Literary Haven - Admin
        </div>

        <ul class="nav nav-pills flex-column mb-auto">
            <li class="nav-item">
                <a href="dashboard.html" class="nav-link">B·∫£ng ƒëi·ªÅu khi·ªÉn</a>
            </li>
            <li class="nav-item">
                <a href="users.html" class="nav-link">Kh√°ch h√†ng</a>
            </li>
            <li class="nav-item">
                <a href="categories.html" class="nav-link">Lo·∫°i s·∫£n ph·∫©m</a>
            </li>
             <li class="nav-item">
                <a href="products.html" class="nav-link active">S·∫£n ph·∫©m</a>
            </li>
            <li class="nav-item">
                <a href="orders.html" class="nav-link">ƒê∆°n h√†ng</a>
            </li>
            <li class="nav-item">
                <a href="statistics.html" class="nav-link">Th·ªëng k√™</a>
            </li>
        </ul>

        <div class="dropdown border-top p-3">
            <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                <img src="https://github.com/mdo.png" alt="mdo" width="32" height="32" class="rounded-circle me-2">
                <strong>Admin</strong>
            </a>
            <ul class="dropdown-menu dropdown-menu-dark text-small shadow">
                <li><a class="dropdown-item" href="#">C√†i ƒë·∫∑t</a></li>
                <li><a class="dropdown-item" href="#">Profile</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="../index.html">ƒêƒÉng xu·∫•t</a></li>
            </ul>
        </div>
    </aside>

    <main class="main-content">
        <div class="container-fluid py-4">
            <div class="card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h1 class="h3 mb-0">Qu·∫£n l√Ω S·∫£n ph·∫©m</h1>
                    <button class="btn btn-primary" onclick="openProductModal(null)">
                        + Th√™m S·∫£n ph·∫©m
                    </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover table-striped">
                            <thead>
                                <tr>
                                    <th>·∫¢nh</th>
                                    <th>M√£ SKU</th>
                                    <th>T√™n S·∫£n ph·∫©m</th>
                                    <th>Lo·∫°i</th>
                                    <th>Gi√° (VND)</th>
                                    <th>T·ªìn kho</th>
                                    <th>Hi·ªán tr·∫°ng</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody id="productListTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="productModalLabel">Th√™m S·∫£n ph·∫©m M·ªõi</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="productForm">
                        <input type="hidden" id="product-id">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="product-sku" class="form-label">M√£ SKU</label>
                                    <input type="text" class="form-control" id="product-sku" required>
                                </div>
                                <div class="mb-3">
                                    <label for="product-name" class="form-label">T√™n S·∫£n ph·∫©m</label>
                                    <input type="text" class="form-control" id="product-name" required>
                                </div>
                                <div class="mb-3">
                                    <label for="product-category" class="form-label">Lo·∫°i (Category)</label>
                                    <input type="text" class="form-control" id="product-category" required placeholder="V√≠ d·ª•: VƒÉn h·ªçc">
                                </div>
                                <div class="mb-3">
                                    <label for="product-subcategory" class="form-label">Ph√¢n lo·∫°i chi ti·∫øt (Subcategory)</label>
                                    <input type="text" class="form-control" id="product-subcategory" required placeholder="V√≠ d·ª•: Ti·ªÉu thuy·∫øt">
                                </div>
                                <div class="mb-3">
                                    <label for="product-unit" class="form-label">ƒê∆°n v·ªã t√≠nh</label>
                                    <input type="text" class="form-control" id="product-unit" required placeholder="V√≠ d·ª•: Cu·ªën, Quy·ªÉn">
                                </div>
                            </div>
                            <div class="col-md-6">
                                
                                <div class="mb-3">
                                    <label for="product-costPrice" class="form-label">üí∞ Gi√° g·ªëc (VND)</label>
                                    <input type="number" class="form-control" id="product-costPrice" min="0" value="0" oninput="calculateSellingPrice()">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="product-profitMargin" class="form-label">T·ªâ l·ªá l·ª£i nhu·∫≠n mong mu·ªën (%)</label>
                                    <input type="number" class="form-control" id="product-profitMargin" min="0" max="100" value="0" oninput="calculateSellingPrice()">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="product-price" class="form-label">üíµ Gi√° b√°n (t√≠nh to√°n, VND)</label>
                                    <input type="number" class="form-control" id="product-price" min="0" value="0" readonly>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="product-qty" class="form-label">S·ªë l∆∞·ª£ng (T·ªìn kho)</label>
                                    <input type="number" class="form-control" id="product-qty" required min="0" value="0">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="product-status" class="form-label">Hi·ªán tr·∫°ng</label>
                                    <select class="form-select" id="product-status" required>
                                        <option value="active">ƒêang b√°n</option>
                                        <option value="inactive">D·ª´ng b√°n (H·∫øt b√°n/·∫®n)</option>
                                    </select>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="product-image-upload" class="form-label">H√¨nh ·∫£nh</label>
                                    <input class="form-control" type="file" id="product-image-upload" accept="image/*">
                                    <div id="image-preview-area" class="mt-2">
                                        </div>
                                    <input type="hidden" id="product-img-path"> </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="product-desc" class="form-label">M√¥ t·∫£</label>
                            <textarea class="form-control" id="product-desc" rows="3" required></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    <button type="button" class="btn btn-primary" onclick="handleSaveProduct()">L∆∞u S·∫£n ph·∫©m</button>
                </div>
            </div>
        </div>
    </div>

   <script src="../bootstrap-5.3.2-dist/js/bootstrap.bundle.min.js"></script>
   
   <script>
        // H√†m ti·ªán √≠ch: L·∫•y v√† l∆∞u d·ªØ li·ªáu t·ª´ Local Storage
        function getData() {
            const dataString = localStorage.getItem('bs_data');
            const SAMPLE = { products: [] }; 
            return JSON.parse(dataString || JSON.stringify(SAMPLE));
        }

        function saveData(data) {
            localStorage.setItem('bs_data', JSON.stringify(data));
        }

        function formatCurrency(number) {
            return number.toLocaleString('vi-VN') + 'ƒë';
        }

        function getNextProductId(products) {
            if (!products || products.length === 0) return 1;
            const maxId = Math.max(...products.map(p => p.id));
            return maxId + 1;
        }

        // ====================================================================
        // H√ÄM T√çNH TO√ÅN GI√Å B√ÅN T·ª∞ ƒê·ªòNG
        // ====================================================================
        function calculateSellingPrice() {
            const costPriceInput = document.getElementById('product-costPrice');
            const profitMarginInput = document.getElementById('product-profitMargin');
            const sellingPriceInput = document.getElementById('product-price');
            
            let costPrice = parseFloat(costPriceInput.value) || 0;
            let profitMargin = parseFloat(profitMarginInput.value) || 0;

            if (costPrice < 0) costPrice = 0;
            if (profitMargin < 0) profitMargin = 0;
            if (profitMargin > 100) profitMargin = 100;
            
            // C√¥ng th·ª©c: Gi√° b√°n = Gi√° g·ªëc * (1 + T·ªâ l·ªá l·ª£i nhu·∫≠n / 100)
            const sellingPrice = costPrice * (1 + profitMargin / 100);
            
            // L√†m tr√≤n ƒë·∫øn s·ªë nguy√™n g·∫ßn nh·∫•t
            sellingPriceInput.value = Math.round(sellingPrice); 
        }

        // ====================================================================
        // H√ÄM HI·ªÇN TH·ªä DANH S√ÅCH S·∫¢N PH·∫®M 
        // ====================================================================
        function renderProductList() {
            const data = getData();
            const products = data.products || [];
            const tableBody = document.getElementById('productListTableBody');
            tableBody.innerHTML = ''; 

            products.forEach(p => {
                const status = p.status || 'active'; 
                const statusText = status === 'active' ? 'ƒêang b√°n' : 'D·ª´ng b√°n';
                const statusClass = status === 'active' ? 'status-active' : 'status-inactive';
                const actionButton = status === 'active' 
                    ? `<button class="btn btn-sm btn-outline-danger" onclick="toggleProductStatus(${p.id}, 'inactive')">D·ª´ng b√°n</button>`
                    : `<button class="btn btn-sm btn-outline-success" onclick="toggleProductStatus(${p.id}, 'active')">K√≠ch ho·∫°t</button>`;
                
                const imageSource = p.img && p.img.startsWith('data:image') ? p.img : p.img || 'https://via.placeholder.com/60?text=No+Img';

                const row = `
                    <tr>
                        <td>
                            <img src="${imageSource}" alt="${p.name}" class="product-image-thumbnail">
                        </td>
                        <td>${p.sku || 'N/A'}</td>
                        <td>${p.name || 'Ch∆∞a ƒë·∫∑t t√™n'}</td>
                        <td>${p.category || 'N/A'} ‚Ä∫ ${p.subcategory || 'N/A'}</td>
                        <td>${formatCurrency(p.price || 0)}</td>
                        <td>${p.qty || 0} ${p.unit || 'sp'}</td>
                        <td><span class="status-tag ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="openProductModal(${p.id})">S·ª≠a</button>
                            ${actionButton}
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        // ====================================================================
        // H√ÄM THAY ƒê·ªîI HI·ªÜN TR·∫†NG S·∫¢N PH·∫®M (Kh√¥ng ƒë·ªïi)
        // ====================================================================
        function toggleProductStatus(id, newStatus) {
            if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën chuy·ªÉn tr·∫°ng th√°i s·∫£n ph·∫©m ID ${id} sang "${newStatus === 'active' ? 'ƒêang b√°n' : 'D·ª´ng b√°n'}" kh√¥ng?`)) {
                return;
            }

            let data = getData();
            const productIndex = data.products.findIndex(p => p.id === id);

            if (productIndex > -1) {
                data.products[productIndex].status = newStatus;
                saveData(data);
                renderProductList(); 
                alert(`ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i s·∫£n ph·∫©m ID ${id} th√†nh "${newStatus === 'active' ? 'ƒêang b√°n' : 'D·ª´ng b√°n'}"!`);
            } else {
                alert('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m!');
            }
        }
        
        // H√†m hi·ªÉn th·ªã ·∫£nh v√† n√∫t x√≥a (Kh√¥ng ƒë·ªïi)
        function displayImagePreview(imgPath) {
            const imagePreviewArea = document.getElementById('image-preview-area');
            const isBase64 = imgPath.startsWith('data:image');
            const displayPath = isBase64 ? 'Base64 Data (ƒê√£ l∆∞u trong LocalStorage)' : imgPath;

            imagePreviewArea.innerHTML = `
                <div class="image-preview-container">
                    <img src="${imgPath}" alt="Preview" style="max-width: 100px; height: auto; margin-right: 10px;">
                    <span class="remove-image-btn" onclick="removeImage()">‚úï</span>
                </div>
                <small class="text-muted d-block">Ngu·ªìn: ${displayPath}</small>
            `;
        }

        // H√†m x√≥a ·∫£nh (Kh√¥ng ƒë·ªïi)
        function removeImage() {
            document.getElementById('product-img-path').value = ''; 
            document.getElementById('product-image-upload').value = ''; 
            
            document.getElementById('image-preview-area').innerHTML = '<small class="text-danger">ƒê√£ x√≥a ·∫£nh hi·ªán t·∫°i. H√£y ch·ªçn ·∫£nh m·ªõi ho·∫∑c l∆∞u ƒë·ªÉ kh√¥ng c√≥ ·∫£nh.</small>';
        }

        // ====================================================================
        // H√ÄM M·ªû MODAL (TH√äM HO·∫∂C S·ª¨A) - ƒê√É T·ªêI ∆ØU H√ìA LOGIC T·∫¢I D·ªÆ LI·ªÜU
        // ====================================================================
        let currentProductId = null;

        function openProductModal(id) {
            const modalTitle = document.getElementById('productModalLabel');
            const form = document.getElementById('productForm');
            const imagePreviewArea = document.getElementById('image-preview-area');
            const fileInput = document.getElementById('product-image-upload');
            
            // RESET T·∫§T C·∫¢
            form.reset();
            imagePreviewArea.innerHTML = '';
            fileInput.value = ''; 
            document.getElementById('product-img-path').value = ''; 
            
            currentProductId = id;
            const data = getData();

            if (id === null) {
                // TH√äM M·ªöI
                modalTitle.textContent = 'Th√™m S·∫£n ph·∫©m M·ªõi';
                document.getElementById('product-status').value = 'active';
                
                // SET M·∫∂C ƒê·ªäNH
                document.getElementById('product-costPrice').value = 0;
                document.getElementById('product-profitMargin').value = 0; // Set m·∫∑c ƒë·ªãnh 0%
                document.getElementById('product-price').value = 0;

            } else {
                // S·ª¨A S·∫¢N PH·∫®M
                modalTitle.textContent = 'S·ª≠a S·∫£n ph·∫©m (ID: ' + id + ')';
                const product = data.products.find(p => p.id === id);

                if (product) {
                    // ƒêi·ªÅn th√¥ng tin c∆° b·∫£n
                    document.getElementById('product-id').value = product.id;
                    document.getElementById('product-sku').value = product.sku || '';
                    document.getElementById('product-name').value = product.name || '';
                    document.getElementById('product-category').value = product.category || '';
                    document.getElementById('product-subcategory').value = product.subcategory || '';
                    document.getElementById('product-unit').value = product.unit || 'Cu·ªën'; 
                    
                    // ƒêI·ªÄN D·ªÆ LI·ªÜU GI√Å T·ª™ DATA ƒê√É L∆ØU
                    document.getElementById('product-costPrice').value = product.costPrice || 0;
                    document.getElementById('product-profitMargin').value = product.profitMargin || 0; 
                    document.getElementById('product-qty').value = product.qty || 0;
                    document.getElementById('product-desc').value = product.desc || '';
                    document.getElementById('product-status').value = product.status || 'active';

                    // X·ª≠ l√Ω h√¨nh ·∫£nh
                    const imgPath = product.img || '';
                    document.getElementById('product-img-path').value = imgPath;
                    if (imgPath) {
                        displayImagePreview(imgPath);
                    }
                    
                    // T√≠nh to√°n l·∫°i gi√° b√°n ngay l·∫≠p t·ª©c d·ª±a tr√™n d·ªØ li·ªáu c≈© ƒë√£ t·∫£i
                    calculateSellingPrice(); 

                } else {
                    alert('L·ªói: Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m c·∫ßn s·ª≠a!');
                    return;
                }
            }

            // Hi·ªÉn th·ªã Modal
            const modal = new bootstrap.Modal(document.getElementById('productModal'));
            modal.show();
        }

        // ====================================================================
        // H√ÄM L∆ØU S·∫¢N PH·∫®M (Kh√¥ng ƒë·ªïi logic l∆∞u data)
        // ====================================================================
        function handleSaveProduct() {
            // L·∫•y gi√° tr·ªã chu·ªói (c·∫ßn ki·ªÉm tra r·ªóng)
            const id = parseInt(document.getElementById('product-id').value) || null;
            const sku = document.getElementById('product-sku').value.trim();
            const name = document.getElementById('product-name').value.trim();
            const category = document.getElementById('product-category').value.trim();
            const subcategory = document.getElementById('product-subcategory').value.trim();
            const desc = document.getElementById('product-desc').value.trim();
            const unit = document.getElementById('product-unit').value.trim();
            const status = document.getElementById('product-status').value; 

            // L·∫•y gi√° tr·ªã s·ªë (T·∫•t c·∫£ ƒë√£ ƒë∆∞·ª£c chuy·ªÉn sang s·ªë tr∆∞·ªõc ƒë√≥)
            const costPrice = parseFloat(document.getElementById('product-costPrice').value || 0);
            const profitMargin = parseFloat(document.getElementById('product-profitMargin').value || 0);
            const price = parseFloat(document.getElementById('product-price').value || 0); // L·∫•y gi√° tr·ªã ƒë√£ ƒë∆∞·ª£c t√≠nh to√°n
            const qty = parseInt(document.getElementById('product-qty').value || 0);
            
            // Ki·ªÉm tra d·ªØ li·ªáu b·∫Øt bu·ªôc (chu·ªói)
            if (!sku || !name || !category || !desc || !unit) {
                alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß c√°c th√¥ng tin c∆° b·∫£n (M√£, T√™n, Lo·∫°i, M√¥ t·∫£, ƒêVT)!');
                return;
            }
            
            // Ki·ªÉm tra t√≠nh h·ª£p l·ªá c·ªßa s·ªë li·ªáu
            if (isNaN(qty) || qty < 0 || costPrice < 0 || profitMargin < 0 || profitMargin > 100) {
                 alert('Gi√° g·ªëc, t·ªìn kho v√† t·ªâ l·ªá l·ª£i nhu·∫≠n ph·∫£i l√† s·ªë h·ª£p l·ªá v√† kh√¥ng √¢m (T·ªâ l·ªá max 100)!');
                return;
            }

            // L·∫•y Base64/path ƒë√£ ƒë∆∞·ª£c l∆∞u t·∫°m th·ªùi 
            let imgPathOrBase64 = document.getElementById('product-img-path').value; 
            
            // X√¢y d·ª±ng ƒë·ªëi t∆∞·ª£ng s·∫£n ph·∫©m m·ªõi/c·∫≠p nh·∫≠t
            const newProduct = {
                sku,
                name,
                category,
                subcategory,
                desc,
                unit,
                qty,
                img: imgPathOrBase64, 
                costPrice,        // L∆ØU TR∆Ø·ªúNG GI√Å G·ªêC
                price,            // L∆ØU GI√Å B√ÅN ƒê√É T√çNH TO√ÅN
                profitMargin, 
                status, 
            };

            let data = getData();
            
            if (id) {
                // C·∫¨P NH·∫¨T (S·ª¨A)
                const productIndex = data.products.findIndex(p => p.id === id);
                if (productIndex > -1) {
                    // Gi·ªØ l·∫°i supplier c≈© (n·∫øu c√≥)
                    const oldSupplier = data.products[productIndex].supplier || '';
                    
                    data.products[productIndex] = { 
                        ...data.products[productIndex], 
                        ...newProduct,                
                        id,                            
                        supplier: oldSupplier          
                    };
                    alert('C·∫≠p nh·∫≠t s·∫£n ph·∫©m th√†nh c√¥ng!');
                } else {
                    alert('L·ªói: Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m ƒë·ªÉ c·∫≠p nh·∫≠t!');
                    return;
                }
            } else {
                // TH√äM M·ªöI
                newProduct.id = getNextProductId(data.products);
                newProduct.supplier = ''; 
                data.products.push(newProduct);
                alert('Th√™m s·∫£n ph·∫©m m·ªõi th√†nh c√¥ng!');
            }

            saveData(data);
            renderProductList(); 
            
            // ƒê√≥ng modal
            const modalElement = document.getElementById('productModal');
            const modal = bootstrap.Modal.getInstance(modalElement);
            modal.hide();
        }

        // ====================================================================
        // X·ª¨ L√ù S·ª∞ KI·ªÜN CH·ªåN FILE (Kh√¥ng ƒë·ªïi)
        // ====================================================================
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('product-image-upload');
            if (fileInput) {
                fileInput.addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    if (file) {
                        // Ki·ªÉm tra k√≠ch th∆∞·ªõc file ƒë·ªÉ tr√°nh qu√° t·∫£i localStorage
                         if (file.size > 5 * 1024 * 1024) { 
                            alert('K√≠ch th∆∞·ªõc ·∫£nh qu√° l·ªõn (> 5MB). Vui l√≤ng ch·ªçn ·∫£nh nh·ªè h∆°n.');
                            event.target.value = ''; 
                            document.getElementById('image-preview-area').innerHTML = '<small class="text-danger">K√≠ch th∆∞·ªõc file kh√¥ng h·ª£p l·ªá!</small>';
                            document.getElementById('product-img-path').value = ''; 
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = function(e) {
                            displayImagePreview(e.target.result);
                            document.getElementById('product-img-path').value = e.target.result; 
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
            
            // Kh·ªüi t·∫°o b·∫£ng s·∫£n ph·∫©m
            renderProductList();
        });

    </script>
</body>
</html>