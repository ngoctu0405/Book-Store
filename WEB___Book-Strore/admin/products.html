<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n l√Ω S·∫£n ph·∫©m</title>
    <link rel="icon" type="image/jpg" href="../images/Logo_pic_removebg.png" />
    <link
      rel="stylesheet"
      href="../bootstrap-5.3.2-dist/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="../assets/css/admin_style.css" />

    <style>
      .product-image-thumbnail {
        width: 60px;
        height: 60px;
        object-fit: cover;
        border-radius: 4px;
      }

      .status-tag {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
      }

      .status-active {
        background-color: #d4edda;
        color: #155724;
      }

      .status-inactive {
        background-color: #f8d7da;
        color: #721c24;
      }

      .image-preview-container {
        position: relative;
        display: inline-block;
      }
      .remove-image-btn {
        position: absolute;
        top: -10px;
        right: -10px;
        background: #dc3545;
        color: white;
        border: 2px solid white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        line-height: 1;
        text-align: center;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
      }

      #product-price {
        background-color: #e9f5ff;
        font-weight: bold;
        color: #0d6efd;
      }
    </style>
  </head>
  <body>
    <aside class="sidebar d-flex flex-column vh-100">
      <div class="sidebar-header">Literary Haven</div>

      <ul class="nav nav-pills flex-column mb-auto">
        <li class="nav-item">
          <a href="dashboard.html" class="nav-link">
            <span class="nav-icon">‚óà</span>
            <span>B·∫£ng ƒëi·ªÅu khi·ªÉn</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="users.html" class="nav-link">
            <span class="nav-icon">‚óâ</span>
            <span>Kh√°ch h√†ng</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="categories.html" class="nav-link">
            <span class="nav-icon">‚ó´</span>
            <span>Lo·∫°i s·∫£n ph·∫©m</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="products.html" class="nav-link active">
            <span class="nav-icon">‚ó™</span>
            <span>S·∫£n ph·∫©m</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="purchase-orders.html" class="nav-link">
            <span class="nav-icon">‚ó©</span>
            <span>Nh·∫≠p h√†ng</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="pricing.html" class="nav-link">
            <span class="nav-icon">‚óé</span>
            <span>Qu·∫£n l√Ω gi√°</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="orders.html" class="nav-link">
            <span class="nav-icon">‚óß</span>
            <span>ƒê∆°n h√†ng</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="inventory.html" class="nav-link">
            <span class="nav-icon">‚ó®</span>
            <span>T·ªìn kho</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="reports.html" class="nav-link">
            <span class="nav-icon">‚óî</span>
            <span>B√°o c√°o</span>
          </a>
        </li>
      </ul>

      <div class="mt-auto p-3">
        <a href="index.html" class="logout-link">
          <span>‚óÄ</span>
          <span>ƒêƒÉng xu·∫•t</span>
        </a>
      </div>
    </aside>

    <main class="main-content">
      <div class="container-fluid py-4">
        <div class="card shadow-sm">
          <div
            class="card-header d-flex justify-content-between align-items-center"
          >
            <h1 class="h3 mb-0">Qu·∫£n l√Ω S·∫£n ph·∫©m</h1>
            <button class="btn btn-primary" onclick="openProductModal(null)">
              + Th√™m S·∫£n ph·∫©m
            </button>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover table-striped">
                <thead>
                  <tr>
                    <th>M√£ ID</th>
                    <th>M√£ SKU</th>
                    <th>T√™n S·∫£n ph·∫©m</th>
                    <th>Lo·∫°i</th>
                    <th>Gi√° (VND)</th>
                    <th>T·ªìn kho</th>
                    <th>Hi·ªán tr·∫°ng</th>
                    <th>H√¨nh ·∫¢nh</th>
                    <th>Thao t√°c</th>
                  </tr>
                </thead>
                <tbody id="productListTableBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>

    <div
      class="modal fade"
      id="productModal"
      tabindex="-1"
      aria-labelledby="productModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="productModalLabel">
              Th√™m S·∫£n ph·∫©m M·ªõi
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <form id="productForm">
              <input type="hidden" id="product-edit-id" />

              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="product-id-display" class="form-label"
                      >M√£ ID (T·ª± ƒë·ªông t·∫°o)</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="product-id-display"
                      disabled
                    />
                  </div>
                  <div class="mb-3">
                    <label for="product-sku" class="form-label">M√£ SKU</label>
                    <input
                      type="text"
                      class="form-control"
                      id="product-sku"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label for="product-name" class="form-label"
                      >T√™n S·∫£n ph·∫©m</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="product-name"
                      required
                    />
                  </div>
                  <div class="mb-3">
                    <label for="product-author" class="form-label"
                      >T√°c gi·∫£</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="product-author"
                      placeholder="Nh·∫≠p t√™n t√°c gi·∫£"
                    />
                  </div>
                  <div class="mb-3">
                    <label for="product-category" class="form-label"
                      >Lo·∫°i (Category)</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="product-category"
                      required
                      placeholder="V√≠ d·ª•: VƒÉn h·ªçc"
                    />
                  </div>
                  <div class="mb-3">
                    <label for="product-subcategory" class="form-label"
                      >Ph√¢n lo·∫°i chi ti·∫øt (Subcategory)</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="product-subcategory"
                      required
                      placeholder="V√≠ d·ª•: Ti·ªÉu thuy·∫øt"
                    />
                  </div>
                  <div class="mb-3">
                    <label for="product-unit" class="form-label"
                      >ƒê∆°n v·ªã t√≠nh</label
                    >
                    <input
                      type="text"
                      class="form-control"
                      id="product-unit"
                      required
                      placeholder="V√≠ d·ª•: Cu·ªën, Quy·ªÉn"
                    />
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="product-costPrice" class="form-label"
                      >üí∞ Gi√° g·ªëc (VND)</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="product-costPrice"
                      min="0"
                      value="0"
                      oninput="calculateSellingPrice()"
                    />
                  </div>
                  <div class="mb-3">
                    <label for="product-profitMargin" class="form-label"
                      >T·ªâ l·ªá l·ª£i nhu·∫≠n mong mu·ªën (%)</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="product-profitMargin"
                      min="0"
                      max="100"
                      value="0"
                      oninput="calculateSellingPrice()"
                    />
                  </div>
                  <div class="mb-3">
                    <label for="product-price" class="form-label"
                      >üíµ Gi√° b√°n (t√≠nh to√°n, VND)</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="product-price"
                      min="0"
                      value="0"
                      readonly
                    />
                  </div>
                  <div class="mb-3">
                    <label for="product-qty" class="form-label"
                      >S·ªë l∆∞·ª£ng (T·ªìn kho)</label
                    >
                    <input
                      type="number"
                      class="form-control"
                      id="product-qty"
                      required
                      min="0"
                      value="0"
                    />
                  </div>
                  <div class="mb-3">
                    <label for="product-status" class="form-label"
                      >Hi·ªán tr·∫°ng</label
                    >
                    <select class="form-select" id="product-status" required>
                      <option value="active">ƒêang b√°n</option>
                      <option value="inactive">D·ª´ng b√°n (H·∫øt b√°n/·∫®n)</option>
                    </select>
                  </div>
                  <div class="mb-3">
                    <label for="product-image-upload" class="form-label"
                      >H√¨nh ·∫£nh</label
                    >
                    <input
                      class="form-control"
                      type="file"
                      id="product-image-upload"
                      accept="image/*"
                    />
                    <div id="image-preview-area" class="mt-2"></div>
                    <input type="hidden" id="product-img-path" />
                  </div>
                </div>
              </div>
              <div class="mb-3">
                <label for="product-desc" class="form-label">M√¥ t·∫£</label>
                <textarea
                  class="form-control"
                  id="product-desc"
                  rows="3"
                  required
                ></textarea>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              ƒê√≥ng
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="handleSaveProduct()"
            >
              L∆∞u S·∫£n ph·∫©m
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="../bootstrap-5.3.2-dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/main.js"></script>
    <script>
      const productModal = new bootstrap.Modal(
        document.getElementById("productModal")
      );

      function renderProductTable() {
        const data = getData();
        const products = data.products || [];

        const tableBody = document.getElementById("productListTableBody");
        tableBody.innerHTML = "";

        if (products.length === 0) {
          tableBody.innerHTML =
            '<tr><td colspan="9" class="text-center">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o.</td></tr>';
          return;
        }

        products.forEach((p) => {
          let statusClass = "";
          let statusText = "";

          if (p.status === "inactive") {
            statusClass = "status-inactive";
            statusText = "D·ª´ng b√°n";
          } else {
            statusClass = "status-active";
            statusText = "ƒêang b√°n";
          }

          const imagePath = p.img ? "../" + p.img : "../images/placeholder.png";

          const row = `
                <tr>
                    <td>${p.id}</td>
                    <td>${p.sku}</td>
                    <td>${p.name}</td>
                    <td>${p.category}</td>
                    <td class="text-end">${(p.price || 0).toLocaleString(
                      "vi-VN"
                    )}ƒë</td>
                    <td class="text-center">${p.qty}</td>
                    <td><span class="status-tag ${statusClass}">${statusText}</span></td>
                    <td>
                        <img src="${imagePath}" alt="${
            p.name
          }" class="product-image-thumbnail">
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="openProductModal(${
                          p.id
                        })">S·ª≠a</button>
                    </td>
                </tr>
            `;
          tableBody.innerHTML += row;
        });
      }

      function openProductModal(productId = null) {
        document.getElementById("productForm").reset();
        removeImagePreview();

        if (productId) {
          document.getElementById("productModalLabel").textContent =
            "S·ª≠a S·∫£n ph·∫©m";

          const data = getData();
          const product = data.products.find((p) => p.id === productId);

          if (!product) {
            alert("Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m!");
            return;
          }

          document.getElementById("product-edit-id").value = product.id;
          document.getElementById("product-id-display").value = product.id;

          document.getElementById("product-sku").value = product.sku;
          document.getElementById("product-name").value = product.name;
          document.getElementById("product-author").value = product.author;
          document.getElementById("product-category").value = product.category;
          document.getElementById("product-subcategory").value =
            product.subcategory;
          document.getElementById("product-unit").value =
            product.unit || "Quy·ªÉn";
          document.getElementById("product-desc").value = product.desc;
          document.getElementById("product-qty").value = product.qty;
          document.getElementById("product-costPrice").value =
            product.costPrice || product.price;
          document.getElementById("product-profitMargin").value =
            product.profitMargin || 0;
          document.getElementById("product-status").value =
            product.status || "active";

          if (product.img) {
            document.getElementById("product-img-path").value = product.img;
            showImagePreview("../" + product.img);
          }
        } else {
          document.getElementById("productModalLabel").textContent =
            "Th√™m S·∫£n ph·∫©m M·ªõi";

          document.getElementById("product-edit-id").value = "";
          document.getElementById("product-id-display").value = "(T·ª± ƒë·ªông t·∫°o)";

          document.getElementById("product-unit").value = "Quy·ªÉn";
          document.getElementById("product-status").value = "active";
        }

        calculateSellingPrice();
        productModal.show();
      }

      function handleSaveProduct() {
        const id = document.getElementById("product-edit-id").value
          ? parseInt(document.getElementById("product-edit-id").value)
          : null;

        const productData = {
          id: id,
          sku: document.getElementById("product-sku").value,
          name: document.getElementById("product-name").value,
          author: document.getElementById("product-author").value,
          category: document.getElementById("product-category").value,
          subcategory: document.getElementById("product-subcategory").value,
          unit: document.getElementById("product-unit").value,
          desc: document.getElementById("product-desc").value,
          qty: parseInt(document.getElementById("product-qty").value) || 0,
          costPrice:
            parseFloat(document.getElementById("product-costPrice").value) || 0,
          profitMargin:
            parseFloat(document.getElementById("product-profitMargin").value) ||
            0,
          price:
            parseFloat(document.getElementById("product-price").value) || 0,
          status: document.getElementById("product-status").value,
          img: document.getElementById("product-img-path").value,
        };

        let data = getData();

        if (id) {
          const index = data.products.findIndex((p) => p.id === id);
          if (index > -1) {
            data.products[index] = { ...data.products[index], ...productData };
          }
        } else {
          productData.id =
            data.products.reduce((max, p) => (p.id > max ? p.id : max), 0) + 1;
          data.products.push(productData);
        }

        saveData(data);

        productModal.hide();
        renderProductTable();
        alert("L∆∞u s·∫£n ph·∫©m th√†nh c√¥ng!");
      }

      function calculateSellingPrice() {
        const costPrice =
          parseFloat(document.getElementById("product-costPrice").value) || 0;
        const profitMargin =
          parseFloat(document.getElementById("product-profitMargin").value) ||
          0;
        const calculatedPrice = costPrice * (1 + profitMargin / 100);
        const roundedPrice = Math.round(calculatedPrice / 1000) * 1000;
        document.getElementById("product-price").value = roundedPrice;
      }

      function handleImageUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          const base64Image = e.target.result;
          document.getElementById("product-img-path").value = base64Image;
          showImagePreview(base64Image);
        };
        reader.readAsDataURL(file);
      }

      function showImagePreview(imageBase64OrPath) {
        const previewArea = document.getElementById("image-preview-area");
        previewArea.innerHTML = `
                <div class="image-preview-container">
                    <img src="${imageBase64OrPath}" style="width: 120px; height: 120px; object-fit: cover; border-radius: 5px;">
                    <span class="remove-image-btn" onclick="removeImagePreview()">‚úï</span>
                </div>
            `;
      }

      function removeImagePreview() {
        document.getElementById("image-preview-area").innerHTML = "";
        document.getElementById("product-img-path").value = "";
        document.getElementById("product-image-upload").value = null;
      }

      document
        .getElementById("product-image-upload")
        .addEventListener("change", handleImageUpload);
      document
        .getElementById("product-costPrice")
        .addEventListener("input", calculateSellingPrice);
      document
        .getElementById("product-profitMargin")
        .addEventListener("input", calculateSellingPrice);

      document.addEventListener("DOMContentLoaded", renderProductTable);
    </script>
  </body>
</html>
