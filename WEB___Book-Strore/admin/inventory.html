<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale-1.0" />
    <title>Qu·∫£n l√Ω T·ªìn kho - Literary Haven Admin</title>

    <link rel="icon" type="image/jpg" href="../images/Logo_pic_removebg.png" />
    <link
      rel="stylesheet"
      href="../bootstrap-5.3.2-dist/css/bootstrap.min.css"
    />
    <link rel="stylesheet" href="../assets/css/admin_style.css" />
    <style>
      /* Responsive cho thi·∫øt b·ªã di ƒë·ªông (max-width: 768px) */
      @media (max-width: 768px) {
        /* 1. Body: Chuy·ªÉn h∆∞·ªõng Flexbox th√†nh column ƒë·ªÉ Sidebar v√† Main-Content x·∫øp ch·ªìng */
        body {
          display: flex !important;
          flex-direction: column !important; /* Quan tr·ªçng: Sidebar s·∫Ω n·∫±m tr√™n Main-Content */
          overflow-x: hidden; /* T·∫Øt cu·ªôn ngang v√¨ ƒë√£ x·∫øp ch·ªìng */
        }

        /* 2. Sidebar: Sidebar gi·ªù chi·∫øm to√†n b·ªô chi·ªÅu r·ªông (100%) */
        .sidebar {
          width: 100% !important;
          /* T·∫Øt vh-100 v√¨ gi·ªù n√≥ n·∫±m ngang, kh√¥ng c·∫ßn chi·ªÅu cao to√†n m√†n h√¨nh */
          height: auto !important;
          flex-shrink: 0;
          display: flex !important;

          /* B·ªï sung: ƒêi·ªÅu ch·ªânh Sidebar ƒë·ªÉ d·ªÖ s·ª≠ d·ª•ng h∆°n khi n·∫±m ngang */
          overflow-x: auto; /* Cho ph√©p menu cu·ªôn ngang n·∫øu c√≥ nhi·ªÅu m·ª•c */
          white-space: nowrap; /* NgƒÉn c√°c m·ª•c menu xu·ªëng d√≤ng */
        }

        /* 3. Main Content: ƒê·∫£m b·∫£o n·ªôi dung ch√≠nh chi·∫øm to√†n b·ªô chi·ªÅu r·ªông */
        .main-content {
          width: 100%;
          min-width: auto;
        }

        /* 4. Tinh ch·ªânh Padding v√† K√≠ch th∆∞·ªõc (b√™n trong page-content) */
        .page-content {
          padding: 15px !important;
        }

        .page-content h1 {
          font-size: 20px;
          margin-bottom: 15px;
        }

        /* 5. ƒêi·ªÅu ch·ªânh b·∫£ng (ƒê·∫£m b·∫£o b·∫£ng v·∫´n cu·ªôn ngang n·∫øu qu√° nhi·ªÅu c·ªôt) */
        .table-responsive {
          border: 1px solid var(--border-color);
          border-radius: 12px;
          overflow-x: auto;
          -webkit-overflow-scrolling: touch;
        }

        .table {
          min-width: 700px; /* TƒÉng min-width do c√≥ th√™m c·ªôt */
        }

        .table thead th,
        .table tbody td {
          padding: 8px 6px;
          font-size: 12px;
        }

        .input-qty {
          width: 50px;
          padding: 4px 2px;
          font-size: 12px;
        }

        .btn-sm,
        .btn-action-small {
          padding: 3px 6px;
          font-size: 10px;
        }

        .table tbody td span.small {
          display: none;
        }
      }

      /* K√≠ch ho·∫°t l·∫°i b·ªë c·ª•c Desktop (Sidebar n·∫±m c·∫°nh Main-Content) */
      @media (min-width: 769px) {
        body {
          display: flex !important;
          flex-direction: row !important; /* Kh√¥i ph·ª•c th√†nh row tr√™n desktop */
          overflow-x: hidden;
        }
        .sidebar {
          /* Gi·∫£ s·ª≠ chi·ªÅu r·ªông desktop l√† 250px */
          width: 250px !important;
          height: 100vh !important; /* Kh√¥i ph·ª•c vh-100 tr√™n desktop */
          display: flex !important;
        }
        .main-content {
          width: 100%;
        }
      }

      /* Style cho input s·ªë l∆∞·ª£ng v√† n√∫t h√†nh ƒë·ªông */
      .input-qty {
        width: 70px;
        padding: 5px;
        margin-right: 5px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        text-align: center;
      }

      .btn-action-small {
        padding: 5px 10px;
        margin: 2px;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <aside class="sidebar d-flex flex-column vh-100">
      <div class="sidebar-header">Literary Haven</div>

      <ul class="nav nav-pills flex-column mb-auto">
        <li class="nav-item">
          <a href="dashboard.html" class="nav-link">
            <span class="nav-icon">‚óà</span>
            <span>B·∫£ng ƒëi·ªÅu khi·ªÉn</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="users.html" class="nav-link">
            <span class="nav-icon">‚óâ</span>
            <span>Kh√°ch h√†ng</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="categories.html" class="nav-link">
            <span class="nav-icon">‚ó´</span>
            <span>Lo·∫°i s·∫£n ph·∫©m</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="products.html" class="nav-link">
            <span class="nav-icon">‚ó™</span>
            <span>S·∫£n ph·∫©m</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="purchase-orders.html" class="nav-link">
            <span class="nav-icon">‚ó©</span>
            <span>Nh·∫≠p h√†ng</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="pricing.html" class="nav-link">
            <span class="nav-icon">‚óé</span>
            <span>Qu·∫£n l√Ω gi√°</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="orders.html" class="nav-link">
            <span class="nav-icon">‚óß</span>
            <span>ƒê∆°n h√†ng</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="inventory.html" class="nav-link active">
            <span class="nav-icon">‚ó®</span>
            <span>T·ªìn kho</span>
          </a>
        </li>
        <li class="nav-item">
          <a href="reports.html" class="nav-link">
            <span class="nav-icon">‚óî</span>
            <span>B√°o c√°o</span>
          </a>
        </li>
      </ul>

      <div class="mt-auto p-3">
        <a href="index.html" class="logout-link">
          <span>‚óÄ</span>
          <span>ƒêƒÉng xu·∫•t</span>
        </a>
      </div>
    </aside>

    <main class="main-content">
      <div class="page-content p-4">
        <h1 class="mb-4">Qu·∫£n L√Ω T·ªìn Kho S·∫£n Ph·∫©m</h1>

        <!-- B·ªô l·ªçc v√† t√¨m ki·∫øm -->
        <div class="card mb-3">
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-3">
                <label for="searchInput" class="form-label">T√¨m ki·∫øm</label>
                <input
                  type="text"
                  class="form-control"
                  id="searchInput"
                  placeholder="T√¨m theo m√£, t√™n s√°ch, t√°c gi·∫£..."
                />
              </div>
              <div class="col-md-2">
                <label for="categoryFilter" class="form-label"
                  >L·ªçc theo lo·∫°i</label
                >
                <select class="form-select" id="categoryFilter">
                  <option value="">T·∫•t c·∫£ lo·∫°i</option>
                </select>
              </div>
              <div class="col-md-2">
                <label for="statusFilter" class="form-label"
                  >L·ªçc theo tr·∫°ng th√°i</label
                >
                <select class="form-select" id="statusFilter">
                  <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                  <option value="normal">B√¨nh th∆∞·ªùng</option>
                  <option value="low">S·∫Øp h·∫øt</option>
                  <option value="out">H·∫øt h√†ng</option>
                  <option value="inactive">D·ª´ng b√°n</option>
                </select>
              </div>
              <div class="col-md-2">
                <label class="form-label d-block">&nbsp;</label>
                <button
                  class="btn btn-primary w-100"
                  onclick="filterInventory()"
                >
                  <span>üîç</span> Tra c·ª©u
                </button>
              </div>
              <div class="col-md-2">
                <label class="form-label d-block">&nbsp;</label>
                <button
                  class="btn btn-secondary w-100"
                  onclick="resetFilters()"
                >
                  <span>‚Ü∫</span> ƒê·∫∑t l·∫°i
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="card card-inventory">
          <div class="card-header card-header-inventory">T·ªìn Kho Hi·ªán T·∫°i</div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-striped table-hover align-middle">
                <thead class="table-dark">
                  <tr>
                    <th scope="col">M√£ SP</th>
                    <th scope="col">T√™n S√°ch</th>
                    <th scope="col" class="text-center">Lo·∫°i</th>
                    <th scope="col" class="text-center">SL C√≤n L·∫°i</th>
                    <th scope="col" class="text-center">Tr·∫°ng Th√°i</th>
                    <th scope="col" class="text-center">Th·ªùi Gian C·∫≠p Nh·∫≠t</th>
                    <th scope="col" class="text-center">H√†nh ƒë·ªông</th>
                  </tr>
                </thead>
                <tbody id="inventoryTableBody">
                  <tr>
                    <td colspan="7" class="text-center">
                      ƒêang t·∫£i d·ªØ li·ªáu t·ªìn kho...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script src="../bootstrap-5.3.2-dist/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/main.js"></script>

    <script>
      // Ng∆∞·ª°ng c·∫£nh b√°o theo y√™u c·∫ßu: d∆∞·ªõi 20 quy·ªÉn
      const LOW_STOCK_THRESHOLD = 20;

      // Bi·∫øn l∆∞u tr·ªØ d·ªØ li·ªáu g·ªëc
      let originalInventoryData = [];

      // --- Helper Functions ---

      /** ƒê·ªãnh d·∫°ng chu·ªói ng√†y th√°ng ISO sang ƒë·ªãnh d·∫°ng gi·ªù-ng√†y th√°ng nƒÉm Vi·ªát Nam. */
      function formatDateTime(dateString) {
        if (!dateString) return "Ch∆∞a c√≥ giao d·ªãch b√°n";
        try {
          const date = new Date(dateString);
          if (isNaN(date)) return "L·ªói ƒë·ªãnh d·∫°ng ng√†y";

          const options = {
            year: "numeric",
            month: "2-digit",
            day: "2-digit",
            hour: "2-digit",
            minute: "2-digit",
            second: "2-digit",
            hour12: false,
          };
          return date.toLocaleDateString("vi-VN", options);
        } catch (e) {
          return "Ch∆∞a c√≥ giao d·ªãch b√°n";
        }
      }

      /**
       * L·∫•y t√™n category t·ª´ s·∫£n ph·∫©m
       */
      function getCategoryName(product) {
        // Tr∆∞·ªùng h·ª£p 1: N·∫øu c√≥ tr∆∞·ªùng category tr·ª±c ti·∫øp (string)
        if (product.category) {
          return product.category;
        }

        // Tr∆∞·ªùng h·ª£p 2: N·∫øu c√≥ categoryId, t√¨m trong danh s√°ch categories
        if (product.categoryId) {
          const data = typeof getData === "function" ? getData() : null;
          if (data && data.categories) {
            const category = data.categories.find(
              (cat) => cat.id === product.categoryId
            );
            if (category) return category.name;
          }
        }

        return "Ch∆∞a ph√¢n lo·∫°i";
      }

      // --- H√†nh ƒë·ªông T∆∞∆°ng t√°c ---

      /**
       * X·ª≠ l√Ω nh·∫≠p th√™m s·ªë l∆∞·ª£ng t·ªìn kho.
       * @param {number} productId - ID s·∫£n ph·∫©m.
       * @param {string} productName - T√™n s·∫£n ph·∫©m.
       */
      function handleImport(productId, productName) {
        const inputElement = document.getElementById(`inputQty_${productId}`);
        const qty = parseInt(inputElement.value);

        if (isNaN(qty) || qty <= 0) {
          alert("Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng h·ª£p l·ªá (> 0) ƒë·ªÉ nh·∫≠p th√™m.");
          return;
        }

        let data = typeof getData === "function" ? getData() : null;
        if (!data) return;

        const productIndex = data.products.findIndex((p) => p.id === productId);

        if (productIndex > -1) {
          const currentStock = data.products[productIndex].qty || 0;

          // C·∫≠p nh·∫≠t t·ªìn kho m·ªõi
          data.products[productIndex].qty = currentStock + qty;
          data.products[productIndex].lastStockUpdate =
            new Date().toISOString();

          // N·∫øu s·∫£n ph·∫©m ƒëang b·ªã kh√≥a, m·ªü kh√≥a (active)
          if (data.products[productIndex].status === "inactive") {
            data.products[productIndex].status = "active";
          }

          if (typeof saveData === "function") {
            saveData(data);
            alert(
              `‚úÖ ƒê√£ nh·∫≠p th√™m ${qty} cu·ªën s√°ch "${productName}". T·ªìn kho m·ªõi: ${
                currentStock + qty
              }.`
            );
            // C·∫≠p nh·∫≠t l·∫°i d·ªØ li·ªáu v√† render
            originalInventoryData = generateInventoryReport();
            filterInventory();
          }
        }
      }

      /**
       * X·ª≠ l√Ω D·ª´ng B√°n/B√°n L·∫°i (Kh√≥a/M·ªü kh√≥a s·∫£n ph·∫©m).
       * @param {number} productId - ID s·∫£n ph·∫©m.
       * @param {string} productName - T√™n s·∫£n ph·∫©m.
       * @param {string} currentStatus - Tr·∫°ng th√°i hi·ªán t·∫°i ('active' ho·∫∑c 'inactive').
       */
      function handleToggleStatus(productId, productName, currentStatus) {
        const newStatus = currentStatus === "active" ? "inactive" : "active";
        const actionText = newStatus === "inactive" ? "D·ª™NG B√ÅN" : "B√ÅN L·∫†I";

        if (
          !confirm(
            `‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ${actionText} s√°ch "${productName}" kh√¥ng?`
          )
        ) {
          return;
        }

        let data = typeof getData === "function" ? getData() : null;
        if (!data) return;

        const productIndex = data.products.findIndex((p) => p.id === productId);

        if (productIndex > -1) {
          data.products[productIndex].status = newStatus;

          if (typeof saveData === "function") {
            saveData(data);
            alert(
              `‚úÖ ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i s√°ch "${productName}" th√†nh: ${
                newStatus === "active" ? "ƒêang B√°n" : "D·ª´ng B√°n (Kh√≥a)"
              }.`
            );
            // C·∫≠p nh·∫≠t l·∫°i d·ªØ li·ªáu v√† render
            originalInventoryData = generateInventoryReport();
            filterInventory();
          }
        }
      }

      // --- RENDERING LOGIC ---

      /**
       * T·∫£i danh s√°ch categories v√†o dropdown filter
       */
      function loadCategoryFilter() {
        const data = typeof getData === "function" ? getData() : null;
        if (!data) return;

        const categoryFilter = document.getElementById("categoryFilter");
        if (!categoryFilter) return;

        // X√≥a c√°c option c≈© (tr·ª´ "T·∫•t c·∫£ lo·∫°i")
        categoryFilter.innerHTML = '<option value="">T·∫•t c·∫£ lo·∫°i</option>';

        // L·∫•y danh s√°ch category t·ª´ data.categories
        if (data.categories && data.categories.length > 0) {
          data.categories.forEach((cat) => {
            const option = document.createElement("option");
            option.value = cat.name;
            option.textContent = cat.name;
            categoryFilter.appendChild(option);
          });
        } else {
          // N·∫øu kh√¥ng c√≥ data.categories, l·∫•y t·ª´ products
          const uniqueCategories = new Set();
          if (data.products) {
            data.products.forEach((p) => {
              const catName = getCategoryName(p);
              if (catName && catName !== "Ch∆∞a ph√¢n lo·∫°i") {
                uniqueCategories.add(catName);
              }
            });

            uniqueCategories.forEach((catName) => {
              const option = document.createElement("option");
              option.value = catName;
              option.textContent = catName;
              categoryFilter.appendChild(option);
            });
          }
        }
      }

      /**
       * L·ªçc v√† t√¨m ki·∫øm t·ªìn kho
       */
      function filterInventory() {
        const searchText = document
          .getElementById("searchInput")
          .value.toLowerCase();
        const categoryFilter = document.getElementById("categoryFilter").value;
        const statusFilter = document.getElementById("statusFilter").value;

        let filteredData = originalInventoryData.filter((item) => {
          // L·ªçc theo text search
          const matchSearch =
            item.sku.toLowerCase().includes(searchText) ||
            item.name.toLowerCase().includes(searchText) ||
            (item.author && item.author.toLowerCase().includes(searchText)) ||
            item.category.toLowerCase().includes(searchText);

          if (!matchSearch) return false;

          // L·ªçc theo category
          if (categoryFilter && item.category !== categoryFilter) {
            return false;
          }

          // L·ªçc theo tr·∫°ng th√°i
          if (statusFilter) {
            if (statusFilter === "out" && item.endQty > 0) return false;
            if (
              statusFilter === "low" &&
              (item.endQty === 0 || item.endQty >= LOW_STOCK_THRESHOLD)
            )
              return false;
            if (
              statusFilter === "normal" &&
              (item.endQty === 0 ||
                item.endQty < LOW_STOCK_THRESHOLD ||
                item.status === "inactive")
            )
              return false;
            if (statusFilter === "inactive" && item.status !== "inactive")
              return false;
          }

          return true;
        });

        renderInventoryTable(filteredData);
      }

      /**
       * Reset t·∫•t c·∫£ b·ªô l·ªçc
       */
      function resetFilters() {
        document.getElementById("searchInput").value = "";
        document.getElementById("categoryFilter").value = "";
        document.getElementById("statusFilter").value = "";
        renderInventoryTable(originalInventoryData);
      }

      /**
       * L·∫•y d·ªØ li·ªáu t·ªìn kho v√† t·∫°o b√°o c√°o
       */
      function generateInventoryReport() {
        const data =
          typeof getData === "function" ? getData() : { products: [] };
        const products = data.products || [];
        const report = [];

        products.forEach((p) => {
          const endQty = p.qty || 0;
          const lastUpdate = p.lastStockUpdate || null;
          const status = p.status || "active"; // M·∫∑c ƒë·ªãnh l√† 'active'

          let stockStatusText = "";
          let rowClass = "";
          let actionElements = "";
          let statusBadge = "";

          // X√°c ƒë·ªãnh tr·∫°ng th√°i t·ªìn kho
          if (endQty <= 0) {
            stockStatusText = "H·∫æT H√ÄNG";
            rowClass = "table-danger";
          } else if (endQty < LOW_STOCK_THRESHOLD) {
            stockStatusText = "S·∫ÆP H·∫æT!";
            rowClass = "table-warning";
          } else {
            stockStatusText = "B√¨nh th∆∞·ªùng";
          }

          // X√°c ƒë·ªãnh tr·∫°ng th√°i b√°n h√†ng v√† h√†nh ƒë·ªông
          if (status === "inactive") {
            statusBadge =
              '<span class="badge bg-secondary">KH√ìA/D·ª™NG B√ÅN</span>';
            rowClass = "table-secondary"; // ∆Øu ti√™n m√†u kh√≥a/d·ª´ng b√°n
            actionElements = `<button class="btn btn-success btn-action-small" onclick="handleToggleStatus(${
              p.id
            }, '${p.name.replace(
              /'/g,
              "\\'"
            )}', '${status}')">B√°n L·∫°i</button>`;
          } else {
            statusBadge = `<span class="badge bg-${
              endQty < LOW_STOCK_THRESHOLD ? "danger" : "success"
            }">${stockStatusText}</span>`;

            // Th√™m √¥ nh·∫≠p s·ªë l∆∞·ª£ng
            actionElements += `<input type="number" id="inputQty_${p.id}" class="input-qty" value="10" min="1">`;
            actionElements += `<button class="btn btn-primary btn-action-small" onclick="handleImport(${
              p.id
            }, '${p.name.replace(/'/g, "\\'")}')">Nh·∫≠p Th√™m</button>`;

            // N√∫t D·ª´ng B√°n
            actionElements += `<button class="btn btn-danger btn-action-small" onclick="handleToggleStatus(${
              p.id
            }, '${p.name.replace(
              /'/g,
              "\\'"
            )}', '${status}')">D·ª´ng B√°n</button>`;
          }

          report.push({
            id: p.id,
            sku: p.sku || "N/A",
            name: p.name || "S·∫£n ph·∫©m kh√¥ng t√™n",
            author: p.author || "",
            category: getCategoryName(p),
            endQty: endQty,
            lastUpdate: formatDateTime(lastUpdate),
            rowClass: rowClass,
            statusBadge: statusBadge,
            actionElements: actionElements,
            status: status,
          });
        });

        return report;
      }

      /**
       * Hi·ªÉn th·ªã d·ªØ li·ªáu b√°o c√°o l√™n b·∫£ng.
       */
      function renderInventoryTable(reportData) {
        const tableBody = document.getElementById("inventoryTableBody");
        if (!tableBody) return;

        let html = "";

        if (reportData.length === 0) {
          html =
            '<tr><td colspan="7" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu t·ªìn kho s√°ch.</td></tr>';
        } else {
          reportData.forEach((item) => {
            const qtyClass =
              item.rowClass === "table-danger" ||
              item.rowClass === "table-warning"
                ? "text-danger fw-bold"
                : "";

            html += `
                        <tr class="${item.rowClass}">
                            <td>${item.sku}</td>
                            <td>${item.name}</td>
                            <td class="text-center">${item.category}</td>
                            <td class="text-center ${qtyClass}">${item.endQty}</td>
                            <td class="text-center">${item.statusBadge}</td>
                            <td class="text-center">${item.lastUpdate}</td>
                            <td class="text-center">${item.actionElements}</td>
                        </tr>
                    `;
          });
        }
        tableBody.innerHTML = html;
      }

      /**
       * H√†m kh·ªüi t·∫°o ch√≠nh
       */
      function initInventoryPage() {
        if (typeof getData !== "function") {
          document.getElementById("inventoryTableBody").innerHTML =
            '<tr><td colspan="7" class="text-center text-danger fw-bold">L·ªói: C·∫ßn import main.js v√† ƒë·∫£m b·∫£o h√†m getData()/saveData() t·ªìn t·∫°i.</td></tr>';
          console.error(
            "L·ªói: H√†m getData() kh√¥ng t·ªìn t·∫°i. Vui l√≤ng ƒë·∫£m b·∫£o main.js ƒë√£ ƒë∆∞·ª£c import."
          );
          return;
        }

        originalInventoryData = generateInventoryReport();
        loadCategoryFilter();
        renderInventoryTable(originalInventoryData);
      }

      // Ch·∫°y h√†m kh·ªüi t·∫°o khi DOM ƒë√£ load
      document.addEventListener("DOMContentLoaded", initInventoryPage);
    </script>
    <a href="#" class="back-to-top" title="L√™n ƒë·∫ßu trang">
      <i class="bi bi-chevron-up">
        <img class="go-up" src="../images/muiten.svg" alt="V·ªÅ trang ch·ªß" />
      </i>
    </a>
  </body>
</html>
